<!doctype html><html><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=X-UA-Compatible content="ie=edge"><link rel=icon href=/fav.png type=image/png><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=preload as=style href="https://fonts.googleapis.com/css2?family=Alata&family=Lora&family=Muli:ital,wght@0,400;0,500;0,600;0,700;1,400;1,500;1,600;1,700&family=Roboto&family=Muli:ital,wght@0,100;0,300;0,400;0,500;0,700;0,900;1,100;1,300;1,400;1,500;1,700;1,900&display=swap"><link rel=stylesheet href="https://fonts.googleapis.com/css2?family=Alata&family=Lora&family=Muli:ital,wght@0,400;0,500;0,600;0,700;1,400;1,500;1,600;1,700&family=Roboto&family=Muli:ital,wght@0,100;0,300;0,400;0,500;0,700;0,900;1,100;1,300;1,400;1,500;1,700;1,900&display=swap" media=print onload='this.media="all"'><noscript><link href="https://fonts.googleapis.com/css2?family=Alata&family=Lora&family=Muli:ital,wght@0,400;0,500;0,600;0,700;1,400;1,500;1,600;1,700&family=Roboto&family=Muli:ital,wght@0,100;0,300;0,400;0,500;0,700;0,900;1,100;1,300;1,400;1,500;1,700;1,900&display=swap" rel=stylesheet></noscript><link rel=stylesheet href=/css/font.css media=all><meta property="og:title" content="Storing IoT Data in a database"><meta property="og:description" content="Learn how to use Stream Analytics to stream data from an IoT hub to a database such as Cosmos DB"><meta property="og:type" content="article"><meta property="og:url" content="https://jimbobbennett.dev/blogs/storing-iot-data-in-a-database/"><meta property="og:image" content="https://jimbobbennett.dev/blogs/storing-iot-data-in-a-database/banner.png"><meta property="article:section" content="blogs"><meta property="article:published_time" content="2019-12-05T23:17:04+00:00"><meta property="article:modified_time" content="2019-12-05T23:17:04+00:00"><meta property="og:site_name" content="JimBobBennett"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://jimbobbennett.dev/blogs/storing-iot-data-in-a-database/banner.png"><meta name=twitter:title content="Storing IoT Data in a database"><meta name=twitter:description content="Learn how to use Stream Analytics to stream data from an IoT hub to a database such as Cosmos DB"><meta name=twitter:site content="@jimbobbennett"><meta name=twitter:creator content="@jimbobbennett"><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css integrity=sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3 crossorigin=anonymous><link rel=stylesheet href=/css/header.css media=all><link rel=stylesheet href=/css/footer.css media=all><link rel=stylesheet href=/css/theme.css media=all><link rel="shortcut icon" type=image/png href=/fav.png><link rel="shortcut icon" sizes=192x192 href=/fav.png><link rel=apple-touch-icon href=/fav.png><link rel=alternate type=application/rss+xml href=https://jimbobbennett.dev/index.xml title=JimBobBennett><script type=text/javascript>(function(e,t,n,s,o,i,a){e[n]=e[n]||function(){(e[n].q=e[n].q||[]).push(arguments)},i=t.createElement(s),i.async=1,i.src="https://www.clarity.ms/tag/"+o,a=t.getElementsByTagName(s)[0],a.parentNode.insertBefore(i,a)})(window,document,"clarity","script","dctc2ydykv")</script><script data-goatcounter=https://jimbobbennett.goatcounter.com/count async src=//gc.zgo.at/count.js></script><style>:root{--text-color:#343a40;--text-secondary-color:#6c757d;--background-color:#000;--secondary-background-color:#64ffda1a;--primary-color:#007bff;--secondary-color:#f8f9fa;--text-color-dark:#e4e6eb;--text-secondary-color-dark:#b0b3b8;--background-color-dark:#000000;--secondary-background-color-dark:#212529;--primary-color-dark:#ffffff;--secondary-color-dark:#212529}body{background-color:#000;font-size:1rem;font-weight:400;line-height:1.5;text-align:left}</style><meta name=description content><link rel=stylesheet href=/css/index.css><link rel=stylesheet href=/css/single.css><link rel=stylesheet href=/css/projects.css media=all><script defer src=/fontawesome-5/all-5.15.4.js></script><title>Storing IoT Data in a database | JimBobBennett</title></head><body class=light onload=loading()><header><nav class="pt-3 navbar navbar-expand-lg"><div class="container-fluid mx-xs-2 mx-sm-5 mx-md-5 mx-lg-5"><a class="navbar-brand primary-font text-wrap" href=/><img src=/fav.png width=30 height=30 class="d-inline-block align-top">
JimBobBennett
</a><button class=navbar-toggler type=button data-bs-toggle=collapse data-bs-target=#navbarContent aria-controls=navbarContent aria-expanded=false aria-label="Toggle navigation"><svg aria-hidden="true" height="24" viewBox="0 0 16 16" width="24" data-view-component="true"><path fill-rule="evenodd" d="M1 2.75A.75.75.0 011.75 2h12.5a.75.75.0 110 1.5H1.75A.75.75.0 011 2.75zm0 5A.75.75.0 011.75 7h12.5a.75.75.0 110 1.5H1.75A.75.75.0 011 7.75zM1.75 12a.75.75.0 100 1.5h12.5a.75.75.0 100-1.5H1.75z"/></svg></button><div class="collapse navbar-collapse text-wrap primary-font" id=navbarContent><ul class="navbar-nav ms-auto text-center"><li class="nav-item navbar-text"><a class=nav-link href=/ aria-label=home>Home</a></li><li class="nav-item navbar-text"><a class=nav-link href=/#about aria-label=about>About</a></li><li class="nav-item navbar-text"><a class=nav-link href=/#projects aria-label=projects>Recent Highlights</a></li><li class="nav-item navbar-text"><a class=nav-link href=/blogs title="Blog posts">Blog</a></li><li class="nav-item navbar-text"><a class=nav-link href=/videos title=Videos>Videos</a></li><li class="nav-item navbar-text"><a class=nav-link href=/livestreams title=Livestreams>Livestreams</a></li><li class="nav-item navbar-text"><a class=nav-link href=/conferences title=Conferences>Conferences</a></li><li class="nav-item navbar-text"><a class=nav-link href=/resume title=Resume>Resume</a></li></ul></div></div></nav></header><div id=content><section id=projects><div class="container pt-5" id=list-page><div class="row justify-content-center px-3 px-md-5"><h1 class="text-left pb-2 content">Storing IoT Data in a database</h1><div class="text-left content"><a href=https://linkedin.com/in/jimbobbennett>Jim Bennett
</a><small>|</small>
Dec 5, 2019</div></div></div></section><section id=single><div class=container><div class="row justify-content-center"><div class="col-sm-12 col-md-12 col-lg-9"><div class=pr-lg-4><article class="page-content p-2"><p>One question that comes up a lot when getting started with IoT is &lsquo;How do I store all this data?&rsquo;. This is an important question - IoT creates a <em>LOT</em> of data, some of which can be analyzed on the fly, but there are a large number of cases where you want to run analytics later, or have access to historical raw data to run new analytics later.</p><p>IoT typically involves ingesting a large number of messages through a single hub, and these hubs are typically dumb - in that they provide a single point to ingest the messages but don&rsquo;t do anything with them. That&rsquo;s the responsibility of the developers building out the IoT solution.</p><p>One area that is powerful with Azure IoT is <a href="https://azure.microsoft.com/services/stream-analytics/?WT.mc_id=streamanalytics-blog-jabenn">Azure Stream Analytics</a>. This is a service that can be connected to any event stream, such as an IoT Hub, and take the live stream of data and do something with it, such as filter, manipulate and output to other systems. You can even wire up ML based anomaly detection to be alerted when unexpected values are received.</p><p>In this post we will see how to use Stream Analytics to stream IoT data into a database. This assumes you already have an IoT hub receiving data.</p><h1 id=create-a-database>Create a database</h1><p>The first thing you need is a database to put the data into. Stream analytics works with both <a href="https://azure.microsoft.com/services/cosmos-db/?WT.mc_id=streamanalytics-blog-jabenn">Azure Cosmos DB</a> and <a href="https://azure.microsoft.com/services/sql-database/?WT.mc_id=streamanalytics-blog-jabenn">Azure SQL Database</a>, as well as many other storage solutions, so it&rsquo;s up to you which one you want to use. In this post I&rsquo;ll use Cosmos DB, but the concepts apply to all data stores.</p><ul><li>Launch the <a href="https://portal.azure.com/?WT.mc_id=streamanalytics-blog-jabenn">Azure Portal</a></li><li>Select <strong>+ Create a resource</strong> from the menu on the left or the dashboard</li><li>Search for <em>Azure Cosmos DB</em>, select it and select <strong>Create</strong></li><li>Select your subscription, select or create a new resource group and name your account.</li><li>Set the API to <em>Core (SQL).</em> Stream Analytics only supports the SQL API.</li><li>Set the location closest to you, then select <strong>Review + create</strong>, then select <strong>Create</strong></li><li>This will take a few minutes to create, so once done load it in the portal</li><li>Create a new collection to store the data. From the Cosmos DB resource, head to the <strong>Data Explorer</strong> tab</li><li>Select <strong>New Container</strong></li><li>Give the database a name</li><li>Set the throughput. You can find a discussion around throughput in <a href="https://docs.microsoft.com/azure/cosmos-db/set-throughput/?WT.mc_id=streamanalytics-blog-jabenn">the documentation</a>. For a simple test setup, set this to be 400 (the minimum).</li><li>Give the container a name</li><li>Set a partition key. You can read more on partition keys in <a href="https://docs.microsoft.com/azure/cosmos-db/partitioning-overview/?WT.mc_id=streamanalytics-blog-jabenn">the documentation</a></li><li>Select <strong>OK</strong></li></ul><h1 id=create-a-stream-analytics-resource>Create a Stream Analytics resource</h1><p>Once you have the database, you need to create a Stream Analytics resource.</p><ul><li>Launch the <a href="https://portal.azure.com/?WT.mc_id=streamanalytics-blog-jabenn">Azure Portal</a></li><li>Select <strong>+ Create a resource</strong> from the menu on the left or the dashboard</li><li>Search for <em>Stream Analytics job</em>, select it and select <strong>Create</strong></li></ul><figure><img src=2019-12-05_14-28-07.png></figure><ul><li>Give the job a name, select your subscription, select or create a new resource group and set the location closest to you.</li><li>Stream Analytics jobs can be hosted in the cloud, or run on the edge via an IoT Edge Gateway device. For now, select <em>Cloud</em>, but you can learn more about running on the edge in <a href="https://docs.microsoft.com/azure/stream-analytics/stream-analytics-edge/?WT.mc_id=streamanalytics-blog-jabenn">the documentation</a>.</li><li>Set the number of Streaming units you need - the more data coming in, the larger the number of streaming units you need. You can read more about streaming units in <a href="https://docs.microsoft.com/azure/stream-analytics/stream-analytics-streaming-unit-consumption/?WT.mc_id=streamanalytics-blog-jabenn">the documentation</a>, and learn about pricing on our <a href="https://azure.microsoft.com/pricing/details/stream-analytics/?WT.mc_id=streamanalytics-blog-jabenn">pricing page</a>. For now leave this as the default of 3.</li></ul><figure><img src=2019-12-05_14-37-25-1.png></figure><ul><li>Select <strong>Create</strong>.</li></ul><h1 id=connect-the-dots>Connect the dots</h1><p>Stream analytics allows you to define inputs, outputs and queries. Queries query inputs and can push data into outputs, so you can query all items from an IoT Hub and select them into a Cosmos DB database. These queries run on the stream as data is received, and output as each item is processed - these are not like traditional SQL queries that run synchronously against a static set of data.</p><h2 id=adding-the-iot-hub-as-an-input>Adding the IoT Hub as an input</h2><ul><li>Select the stream analytics job in the Azure portal</li><li>Head to the <strong>Inputs</strong> tab</li><li>Select <strong>+ Add stream input</strong>, then select <em>IoT Hub</em></li></ul><figure><img src=2019-12-05_14-47-41.png></figure><ul><li>Give the input an alias - this is the name you will use in your queries</li><li>Ensure <em>Select IoT Hub from your subscription</em> is selected, and select your IoT Hub. Leave the rest of the values as the defaults.</li><li>Select <strong>Save</strong></li></ul><h2 id=adding-cosmos-db-as-an-output>Adding Cosmos DB as an output</h2><ul><li>Head to the <strong>Outputs</strong> tab</li><li>Select <strong>+ Add</strong>, then select <em>Cosmos DB</em></li></ul><figure><img src=2019-12-05_14-52-46.png></figure><ul><li>Give the output an alias - this is the name you will use in your queries</li><li>Ensure <em>Select Cosmos DB from your subscriptions</em> is selected, and select your Cosmos DB account, database and container.</li><li>Set the <strong>Document id</strong> field to be the unique key field for the records you will be inserting. If you are inserting directly from IoT Hub without any translation then use what ever unique id is set on each message.</li><li>Select <strong>Save</strong></li></ul><h2 id=building-the-query>Building the query</h2><ul><li>Head to the <strong>Query</strong> tab</li><li>Change the query to be:</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>SELECT</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>*</span>
</span></span><span style=display:flex><span> <span style=color:#66d9ef>INTO</span>
</span></span><span style=display:flex><span>   [cosmos<span style=color:#f92672>-</span>db]
</span></span><span style=display:flex><span> <span style=color:#66d9ef>FROM</span>
</span></span><span style=display:flex><span>   [iot<span style=color:#f92672>-</span>hub]
</span></span></code></pre></div><ul><li>Set <code>[cosmos-db]</code> to be the alias you used for your Cosmos DB database. This needs to be inside square brackets, so if you used <code>myCosmosDB</code> as the alias, you would use <code>[myCosmosDB]</code>.</li><li>Set <code>[iot-hub]</code> to be the alias of the IoT hub, again inside square brackets</li><li>Select <strong>Save query</strong></li></ul><h2 id=start-the-query>Start the query</h2><ul><li>Head the the <strong>Overview</strong> tab</li><li>Select <strong>Start</strong></li><li>The query will start listening to data coming in the input, and send it to the output</li></ul><p>Once data comes in, you will be able to see it appear in Cosmos DB.</p><h1 id=learn-more>Learn more</h1><ul><li>Create a free <a href="https://azure.microsoft.com/free/?WT.mc_id=streamanalytics-blog-jabenn">Azure account</a></li><li>Check out the <a href="https://docs.microsoft.com/azure/stream-analytics/stream-analytics-introduction/?WT.mc_id=streamanalytics-blog-jabenn">Stream Analytics documentation</a>.</li><li>Browse the [Stream Analytics modules on Microsoft Learn](<a href="https://docs.microsoft.com/learn/browse/?term=stream">https://docs.microsoft.com/learn/browse/?term=stream</a> analytics&amp;WT.mc_id=streamanalytics-blog-jabenn) and grow your skills via hands on learning.</li></ul></article></div></div><div class="col-sm-12 col-md-12 col-lg-3"><div class=sticky-sidebar><aside class=toc><h5>Table Of Contents</h5><div class=toc-content><nav id=TableOfContents><ul><li><a href=#adding-the-iot-hub-as-an-input>Adding the IoT Hub as an input</a></li><li><a href=#adding-cosmos-db-as-an-output>Adding Cosmos DB as an output</a></li><li><a href=#building-the-query>Building the query</a></li><li><a href=#start-the-query>Start the query</a></li></ul></nav></div></aside><aside class=tags><h5>Tags</h5><ul class="tags-ul list-unstyled list-inline"><li class=list-inline-item><a href=https://jimbobbennett.dev/tags/technology target=_blank>technology</a></li><li class=list-inline-item><a href=https://jimbobbennett.dev/tags/azure target=_blank>azure</a></li><li class=list-inline-item><a href=https://jimbobbennett.dev/tags/iot target=_blank>IoT</a></li><li class=list-inline-item><a href=https://jimbobbennett.dev/tags/iot-hub target=_blank>Iot Hub</a></li><li class=list-inline-item><a href=https://jimbobbennett.dev/tags/cosmos-db target=_blank>cosmos db</a></li><li class=list-inline-item><a href=https://jimbobbennett.dev/tags/stream-analytics target=_blank>stream analytics</a></li></ul></aside></div></div></div><div class=row><div class="col-sm-12 col-md-12 col-lg-9 p-4"><div id=disqus_thread></div><script>var disqus_config=function(){this.page.url="https://jimbobbennett.dev/blogs/storing-iot-data-in-a-database/",this.page.identifier="3d9b96004c24093ac40f763649abfdcf"};(function(){if(window.location.hostname=="localhost")return;var e=document,t=e.createElement("script");t.src="https://jimbobbennett.disqus.com/embed.js",t.setAttribute("data-timestamp",+new Date),(e.head||e.body).appendChild(t)})()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript></div></div></div><button class="p-2 px-3" onclick=topFunction() id=topScroll>
<i class="fas fa-angle-up"></i></button></section><script>var topScroll=document.getElementById("topScroll");window.onscroll=function(){scrollFunction()};function scrollFunction(){document.body.scrollTop>20||document.documentElement.scrollTop>20?topScroll.style.display="block":topScroll.style.display="none"}function topFunction(){document.body.scrollTop=0,document.documentElement.scrollTop=0}</script></div><footer><div class="container py-4"><div class="row justify-content-center"><div class="col-md-4 text-center">&copy; 2023 All Rights Reserved</div></div></div></div></footer><script src=https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.min.js integrity=sha384-QJHtvGhmr9XOIpI6YVutG+2QOK9T+ZnN4kzFN1RtK3zEFEIsxhlmWl5/YESvpZ13 crossorigin=anonymous></script><script>document.body.className.includes("light")&&(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))</script><script>let loadingIcons;function loading(){myVar=setTimeout(showPage,100)}function showPage(){try{document.getElementById("loading-icons").style.display="block"}catch{}}</script><script>function createCopyButton(e,t){const n=document.createElement("button");n.className="copy-code-button",n.type="button",n.innerText="Copy",n.addEventListener("click",()=>copyCodeToClipboard(n,e,t)),addCopyButtonToDom(n,e)}async function copyCodeToClipboard(e,t,n){const s=t.querySelector("pre > code").innerText;try{n.writeText(s)}finally{codeWasCopied(e)}}function codeWasCopied(e){e.blur(),e.innerText="Copied!",setTimeout(function(){e.innerText="Copy"},2e3)}function addCopyButtonToDom(e,t){t.insertBefore(e,t.firstChild);const n=document.createElement("div");n.className="highlight-wrapper",t.parentNode.insertBefore(n,t),n.appendChild(t)}if(navigator&&navigator.clipboard)document.querySelectorAll(".highlight").forEach(e=>createCopyButton(e,navigator.clipboard));else{var script=document.createElement("script");script.src="https://cdnjs.cloudflare.com/ajax/libs/clipboard-polyfill/2.7.0/clipboard-polyfill.promise.js",script.integrity="sha256-waClS2re9NUbXRsryKoof+F9qc1gjjIhc2eT7ZbIv94=",script.crossOrigin="anonymous",script.onload=function(){addCopyButtons(clipboard)},document.querySelectorAll(".highlight").forEach(e=>createCopyButton(e,script)),document.body.appendChild(script)}</script></body></html>