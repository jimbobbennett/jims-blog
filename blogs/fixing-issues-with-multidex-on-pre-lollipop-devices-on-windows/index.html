<!doctype html><html><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=X-UA-Compatible content="ie=edge"><link rel=icon href=/fav.png type=image/png><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=preload as=style href="https://fonts.googleapis.com/css2?family=Alata&family=Lora&family=Muli:ital,wght@0,400;0,500;0,600;0,700;1,400;1,500;1,600;1,700&family=Roboto&family=Muli:ital,wght@0,100;0,300;0,400;0,500;0,700;0,900;1,100;1,300;1,400;1,500;1,700;1,900&display=swap"><link rel=stylesheet href="https://fonts.googleapis.com/css2?family=Alata&family=Lora&family=Muli:ital,wght@0,400;0,500;0,600;0,700;1,400;1,500;1,600;1,700&family=Roboto&family=Muli:ital,wght@0,100;0,300;0,400;0,500;0,700;0,900;1,100;1,300;1,400;1,500;1,700;1,900&display=swap" media=print onload='this.media="all"'><noscript><link href="https://fonts.googleapis.com/css2?family=Alata&family=Lora&family=Muli:ital,wght@0,400;0,500;0,600;0,700;1,400;1,500;1,600;1,700&family=Roboto&family=Muli:ital,wght@0,100;0,300;0,400;0,500;0,700;0,900;1,100;1,300;1,400;1,500;1,700;1,900&display=swap" rel=stylesheet></noscript><link rel=stylesheet href=/css/font.css media=all><meta property="og:title" content="Fixing issues with Multidex on pre-lollipop devices on Windows"><meta property="og:description" content="When building large apps on Android you may end up getting a weird &lsquo;Java has exited with code 2&rsquo;. This is caused by a limitation when building Android apps of 65,536 fields. Sounds odd I know, but your app can&rsquo;t contain are than 65k fields - a field being a method, property or similar. You may think that this is a lot, but this also includes any other libraries you use, and just by including google maps you&rsquo;re already half way there."><meta property="og:type" content="article"><meta property="og:url" content="https://jimbobbennett.dev/blogs/fixing-issues-with-multidex-on-pre-lollipop-devices-on-windows/"><meta property="og:image" content="https://jimbobbennett.dev/blogs/fixing-issues-with-multidex-on-pre-lollipop-devices-on-windows/banner.png"><meta property="article:section" content="blogs"><meta property="article:published_time" content="2016-05-20T08:20:16+00:00"><meta property="article:modified_time" content="2016-05-20T08:20:16+00:00"><meta property="og:site_name" content="JimBobBennett"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://jimbobbennett.dev/blogs/fixing-issues-with-multidex-on-pre-lollipop-devices-on-windows/banner.png"><meta name=twitter:title content="Fixing issues with Multidex on pre-lollipop devices on Windows"><meta name=twitter:description content="When building large apps on Android you may end up getting a weird &lsquo;Java has exited with code 2&rsquo;. This is caused by a limitation when building Android apps of 65,536 fields. Sounds odd I know, but your app can&rsquo;t contain are than 65k fields - a field being a method, property or similar. You may think that this is a lot, but this also includes any other libraries you use, and just by including google maps you&rsquo;re already half way there."><meta name=twitter:site content="@jimbobbennett"><meta name=twitter:creator content="@jimbobbennett"><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css integrity=sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3 crossorigin=anonymous><link rel=stylesheet href=/css/header.css media=all><link rel=stylesheet href=/css/footer.css media=all><link rel=stylesheet href=/css/theme.css media=all><link rel="shortcut icon" type=image/png href=/fav.png><link rel="shortcut icon" sizes=192x192 href=/fav.png><link rel=apple-touch-icon href=/fav.png><link rel=alternate type=application/rss+xml href=https://jimbobbennett.dev/index.xml title=JimBobBennett><script type=text/javascript>(function(e,t,n,s,o,i,a){e[n]=e[n]||function(){(e[n].q=e[n].q||[]).push(arguments)},i=t.createElement(s),i.async=1,i.src="https://www.clarity.ms/tag/"+o,a=t.getElementsByTagName(s)[0],a.parentNode.insertBefore(i,a)})(window,document,"clarity","script","dctc2ydykv")</script><script data-goatcounter=https://jimbobbennett.goatcounter.com/count async src=//gc.zgo.at/count.js></script><style>:root{--text-color:#343a40;--text-secondary-color:#6c757d;--background-color:#000;--secondary-background-color:#64ffda1a;--primary-color:#007bff;--secondary-color:#f8f9fa;--text-color-dark:#e4e6eb;--text-secondary-color-dark:#b0b3b8;--background-color-dark:#000000;--secondary-background-color-dark:#212529;--primary-color-dark:#ffffff;--secondary-color-dark:#212529}body{background-color:#000;font-size:1rem;font-weight:400;line-height:1.5;text-align:left}</style><meta name=description content><link rel=stylesheet href=/css/index.css><link rel=stylesheet href=/css/single.css><link rel=stylesheet href=/css/projects.css media=all><script defer src=/fontawesome-5/all-5.15.4.js></script><title>Fixing issues with Multidex on pre-lollipop devices on Windows | JimBobBennett</title></head><body class=light onload=loading()><header><nav class="pt-3 navbar navbar-expand-lg"><div class="container-fluid mx-xs-2 mx-sm-5 mx-md-5 mx-lg-5"><a class="navbar-brand primary-font text-wrap" href=/><img src=/fav.png width=30 height=30 class="d-inline-block align-top">
JimBobBennett
</a><button class=navbar-toggler type=button data-bs-toggle=collapse data-bs-target=#navbarContent aria-controls=navbarContent aria-expanded=false aria-label="Toggle navigation"><svg aria-hidden="true" height="24" viewBox="0 0 16 16" width="24" data-view-component="true"><path fill-rule="evenodd" d="M1 2.75A.75.75.0 011.75 2h12.5a.75.75.0 110 1.5H1.75A.75.75.0 011 2.75zm0 5A.75.75.0 011.75 7h12.5a.75.75.0 110 1.5H1.75A.75.75.0 011 7.75zM1.75 12a.75.75.0 100 1.5h12.5a.75.75.0 100-1.5H1.75z"/></svg></button><div class="collapse navbar-collapse text-wrap primary-font" id=navbarContent><ul class="navbar-nav ms-auto text-center"><li class="nav-item navbar-text"><a class=nav-link href=/ aria-label=home>Home</a></li><li class="nav-item navbar-text"><a class=nav-link href=/#about aria-label=about>About</a></li><li class="nav-item navbar-text"><a class=nav-link href=/#projects aria-label=projects>Recent Highlights</a></li><li class="nav-item navbar-text"><a class=nav-link href=/blogs title="Blog posts">Blog</a></li><li class="nav-item navbar-text"><a class=nav-link href=/videos title=Videos>Videos</a></li><li class="nav-item navbar-text"><a class=nav-link href=/livestreams title=Livestreams>Livestreams</a></li><li class="nav-item navbar-text"><a class=nav-link href=/conferences title=Conferences>Conferences</a></li><li class="nav-item navbar-text"><a class=nav-link href=/resume title=Resume>Resume</a></li></ul></div></div></nav></header><div id=content><section id=projects><div class="container pt-5" id=list-page><div class="row justify-content-center px-3 px-md-5"><h1 class="text-left pb-2 content">Fixing issues with Multidex on pre-lollipop devices on Windows</h1><div class="text-left content"><a href=https://linkedin.com/in/jimbobbennett>Jim Bennett
</a><small>|</small>
May 20, 2016</div></div></div></section><section id=single><div class=container><div class="row justify-content-center"><div class="col-sm-12 col-md-12 col-lg-9"><div class=pr-lg-4><article class="page-content p-2"><p>When building large apps on Android you may end up getting a weird &lsquo;Java has exited with code 2&rsquo;. This is caused by a limitation when building Android apps of 65,536 fields. Sounds odd I know, but your app can&rsquo;t contain are than 65k fields - a field being a method, property or similar. You may think that this is a lot, but this also includes any other libraries you use, and just by including google maps you&rsquo;re already half way there. You can get more information on this <a href=https://developer.android.com/studio/build/multidex.html>on the Android developer page</a>.</p><p>Luckily there is a way round this - multidex. When Android compiles your app it puts the code into a dex file and these dex files have the 64k limit. To exceed this limit the compiler can create multiple dex files, each with 64k fields in it. This seems like an overcomplicated solution, but from our perspective it&rsquo;s simple - just tick a box on the project settings and the Xamarin SDK/Android SDK does the magic.</p><div class=image-div style=width:300px><p><img src=Screen-Shot-2016-05-20-at-19-38-58.png alt></p></div><p>Your Android app needs an application class to run, and if you don&rsquo;t have a custom application class in your app it gets the default Android one - Application. When you set your app to use multidex the default application class that is used is MultiDexApplication. Now if you have your own custom application class that derives from Application, then setting multidex will tweak your code so that it derives from MultiDexApplication.
In addition to this when your app is launched it needs to run the application. In the case of an app with multiple dex files it needs to look in all the dexes to find the application class. On Lollipop and above this is not a problem, the OS is built to understand this and teach for the application. However on previous versions such as KitKat multidex wasn&rsquo;t built in, so the OS will only ever look in the first dex file as this is all it knows about. If the application class is not found, the app crashes on startup.
Again normally this is nothing to worry about. When your app is built it knows which classes to put in the first dex file - it creates a list of classes to put in the main dex and uses this during the build. This means when your app is launched on a pre-lollipop device the right code is in the main dex so your app is launched, and because it uses MultiDexApplication this will cause the other dexes to load.</p><p>So for a developer - just tick the box and job done.</p><p>Except when it goes wrong. I&rsquo;ve spent the last few weeks with an issue where my large app crashes instantly on KitKat because it can&rsquo;t find the application class.
Luckily I&rsquo;ve had access to Xamarin support to help look into this.</p><p>It seems the issue is caused by a bug in the Android SDK on Windows. See <a href="https://code.google.com/p/android/issues/detail?id=187721">https://code.google.com/p/android/issues/detail?id=187721</a> for more details, but basically when it generates the list of classes to put in the first dex, the list ends up empty.</p><p>This only affects the Android SDK on Windows, and so far it&rsquo;s in the latest build tools versions - 23 and up. There is a simple fix, a big thanks to Jon Douglas at Xamarin for providing this.</p><p>What you need to do is edit the <code>mainDexClasses.bat</code> file inside <code>android-sdk\build-tools\23.0.3</code> (or whatever is your latest version). It also helps to delete all earlier versions to ensure the wrong one doesn&rsquo;t get used. In this file, near the bottom, change:</p><pre tabindex=0><code>if DEFINED output goto redirect
call &#34;%java_exe%&#34; -Djava.ext.dirs=&#34;%frameworkdir%&#34; com.android.multidex.MainDexListBuilder &#34;%disableKeepAnnotated%&#34; &#34;%tmpJar%&#34; &#34;%params%&#34;
goto afterClassReferenceListBuilder
:redirect
call &#34;%java_exe%&#34; -Djava.ext.dirs=&#34;%frameworkdir%&#34; com.android.multidex.MainDexListBuilder &#34;%disableKeepAnnotated%&#34; &#34;%tmpJar%&#34; &#34;%params%&#34; 1&gt;&#34;%output%&#34;
:afterClassReferenceListBuilder
</code></pre><p>to:</p><pre tabindex=0><code>SET params=%params:&#39;=%
if DEFINED output goto redirect
call &#34;%java_exe%&#34; -Djava.ext.dirs=&#34;%frameworkdir%&#34; com.android.multidex.MainDexListBuilder %disableKeepAnnotated% &#34;%tmpJar%&#34; %params%
goto afterClassReferenceListBuilder
:redirect
call &#34;%java_exe%&#34; -Djava.ext.dirs=&#34;%frameworkdir%&#34; com.android.multidex.MainDexListBuilder %disableKeepAnnotated% &#34;%tmpJar%&#34; %params% 1&gt;&#34;%output%&#34;
:afterClassReferenceListBuilder
</code></pre><p>And that&rsquo;s it! Rebuild your app and it should now run on pre-lollipop devices.</p><p>This only affects Android builds on Windows, not on Mac. Also be aware though that there is a different bug in Xamarin on the alpha and beta channel that causes issues with Multidex, so if you&rsquo;re running into a problem on these versions you&rsquo;ll need to update to stable until a fix is released.</p><hr><p>And here&rsquo;s a better blog post on it from the engineer at Xamarin who helped me solve the issue.</p><p><a href=http://www.jon-douglas.com/2016/09/05/xamarin-android-multidex/>http://www.jon-douglas.com/2016/09/05/xamarin-android-multidex/</a></p></article></div></div><div class="col-sm-12 col-md-12 col-lg-3"><div class=sticky-sidebar><aside class=toc><h5>Table Of Contents</h5><div class=toc-content><nav id=TableOfContents></nav></div></aside><aside class=tags><h5>Tags</h5><ul class="tags-ul list-unstyled list-inline"><li class=list-inline-item><a href=https://jimbobbennett.dev/tags/xamarin target=_blank>xamarin</a></li><li class=list-inline-item><a href=https://jimbobbennett.dev/tags/xamarin.android target=_blank>xamarin.android</a></li><li class=list-inline-item><a href=https://jimbobbennett.dev/tags/multidex target=_blank>multidex</a></li><li class=list-inline-item><a href=https://jimbobbennett.dev/tags/java target=_blank>java</a></li><li class=list-inline-item><a href=https://jimbobbennett.dev/tags/crash target=_blank>crash</a></li><li class=list-inline-item><a href=https://jimbobbennett.dev/tags/windows target=_blank>windows</a></li></ul></aside></div></div></div><div class=row><div class="col-sm-12 col-md-12 col-lg-9 p-4"><div id=disqus_thread></div><script>var disqus_config=function(){this.page.url="https://jimbobbennett.dev/blogs/fixing-issues-with-multidex-on-pre-lollipop-devices-on-windows/",this.page.identifier="0ef2e6fd2eda86ed9e52b378f56f2363"};(function(){if(window.location.hostname=="localhost")return;var e=document,t=e.createElement("script");t.src="https://jimbobbennett.disqus.com/embed.js",t.setAttribute("data-timestamp",+new Date),(e.head||e.body).appendChild(t)})()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript></div></div></div><button class="p-2 px-3" onclick=topFunction() id=topScroll>
<i class="fas fa-angle-up"></i></button></section><script>var topScroll=document.getElementById("topScroll");window.onscroll=function(){scrollFunction()};function scrollFunction(){document.body.scrollTop>20||document.documentElement.scrollTop>20?topScroll.style.display="block":topScroll.style.display="none"}function topFunction(){document.body.scrollTop=0,document.documentElement.scrollTop=0}</script></div><footer><div class="container py-4"><div class="row justify-content-center"><div class="col-md-4 text-center">&copy; 2024 All Rights Reserved</div></div></div></div></footer><script src=https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.min.js integrity=sha384-QJHtvGhmr9XOIpI6YVutG+2QOK9T+ZnN4kzFN1RtK3zEFEIsxhlmWl5/YESvpZ13 crossorigin=anonymous></script><script>document.body.className.includes("light")&&(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))</script><script>let loadingIcons;function loading(){myVar=setTimeout(showPage,100)}function showPage(){try{document.getElementById("loading-icons").style.display="block"}catch{}}</script><script>function createCopyButton(e,t){const n=document.createElement("button");n.className="copy-code-button",n.type="button",n.innerText="Copy",n.addEventListener("click",()=>copyCodeToClipboard(n,e,t)),addCopyButtonToDom(n,e)}async function copyCodeToClipboard(e,t,n){const s=t.querySelector("pre > code").innerText;try{n.writeText(s)}finally{codeWasCopied(e)}}function codeWasCopied(e){e.blur(),e.innerText="Copied!",setTimeout(function(){e.innerText="Copy"},2e3)}function addCopyButtonToDom(e,t){t.insertBefore(e,t.firstChild);const n=document.createElement("div");n.className="highlight-wrapper",t.parentNode.insertBefore(n,t),n.appendChild(t)}if(navigator&&navigator.clipboard)document.querySelectorAll(".highlight").forEach(e=>createCopyButton(e,navigator.clipboard));else{var script=document.createElement("script");script.src="https://cdnjs.cloudflare.com/ajax/libs/clipboard-polyfill/2.7.0/clipboard-polyfill.promise.js",script.integrity="sha256-waClS2re9NUbXRsryKoof+F9qc1gjjIhc2eT7ZbIv94=",script.crossOrigin="anonymous",script.onload=function(){addCopyButtons(clipboard)},document.querySelectorAll(".highlight").forEach(e=>createCopyButton(e,script)),document.body.appendChild(script)}</script></body></html>