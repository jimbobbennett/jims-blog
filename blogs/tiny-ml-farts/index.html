<!doctype html><html><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=X-UA-Compatible content="ie=edge"><link rel=icon href=/fav.png type=image/png><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=preload as=style href="https://fonts.googleapis.com/css2?family=Alata&family=Lora&family=Muli:ital,wght@0,400;0,500;0,600;0,700;1,400;1,500;1,600;1,700&family=Roboto&family=Muli:ital,wght@0,100;0,300;0,400;0,500;0,700;0,900;1,100;1,300;1,400;1,500;1,700;1,900&display=swap"><link rel=stylesheet href="https://fonts.googleapis.com/css2?family=Alata&family=Lora&family=Muli:ital,wght@0,400;0,500;0,600;0,700;1,400;1,500;1,600;1,700&family=Roboto&family=Muli:ital,wght@0,100;0,300;0,400;0,500;0,700;0,900;1,100;1,300;1,400;1,500;1,700;1,900&display=swap" media=print onload='this.media="all"'><noscript><link href="https://fonts.googleapis.com/css2?family=Alata&family=Lora&family=Muli:ital,wght@0,400;0,500;0,600;0,700;1,400;1,500;1,600;1,700&family=Roboto&family=Muli:ital,wght@0,100;0,300;0,400;0,500;0,700;0,900;1,100;1,300;1,400;1,500;1,700;1,900&display=swap" rel=stylesheet></noscript><link rel=stylesheet href=/css/font.css media=all><meta property="og:title" content="Using TinyML to identify farts"><meta property="og:description" content="Jim built an AI model that runs on a microcontroller to identify different fart sounds. Be warned - this blog post is a stinker!"><meta property="og:type" content="article"><meta property="og:url" content="https://jimbobbennett.dev/blogs/tiny-ml-farts/"><meta property="og:image" content="https://jimbobbennett.dev/blogs/tiny-ml-farts/banner.png"><meta property="article:section" content="blogs"><meta property="article:published_time" content="2021-02-22T17:01:05+00:00"><meta property="article:modified_time" content="2021-02-22T17:01:05+00:00"><meta property="og:site_name" content="JimBobBennett"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://jimbobbennett.dev/blogs/tiny-ml-farts/banner.png"><meta name=twitter:title content="Using TinyML to identify farts"><meta name=twitter:description content="Jim built an AI model that runs on a microcontroller to identify different fart sounds. Be warned - this blog post is a stinker!"><meta name=twitter:site content="@jimbobbennett"><meta name=twitter:creator content="@jimbobbennett"><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css integrity=sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3 crossorigin=anonymous><link rel=stylesheet href=/css/header.css media=all><link rel=stylesheet href=/css/footer.css media=all><link rel=stylesheet href=/css/theme.css media=all><link rel="shortcut icon" type=image/png href=/fav.png><link rel="shortcut icon" sizes=192x192 href=/fav.png><link rel=apple-touch-icon href=/fav.png><link rel=alternate type=application/rss+xml href=https://jimbobbennett.dev//index.xml title=JimBobBennett><script type=text/javascript>(function(e,t,n,s,o,i,a){e[n]=e[n]||function(){(e[n].q=e[n].q||[]).push(arguments)},i=t.createElement(s),i.async=1,i.src="https://www.clarity.ms/tag/"+o,a=t.getElementsByTagName(s)[0],a.parentNode.insertBefore(i,a)})(window,document,"clarity","script","dctc2ydykv")</script><script data-goatcounter=https://jimbobbennett.goatcounter.com/count async src=//gc.zgo.at/count.js></script><style>:root{--text-color:#343a40;--text-secondary-color:#6c757d;--background-color:#000;--secondary-background-color:#64ffda1a;--primary-color:#007bff;--secondary-color:#f8f9fa;--text-color-dark:#e4e6eb;--text-secondary-color-dark:#b0b3b8;--background-color-dark:#000000;--secondary-background-color-dark:#212529;--primary-color-dark:#ffffff;--secondary-color-dark:#212529}body{background-color:#000;font-size:1rem;font-weight:400;line-height:1.5;text-align:left}</style><meta name=description content="Jim built an AI model that runs on a microcontroller to identify different fart sounds. Be warned - this blog post is a stinker!"><link rel=stylesheet href=/css/index.css><link rel=stylesheet href=/css/single.css><link rel=stylesheet href=/css/projects.css media=all><script defer src=/fontawesome-5/all-5.15.4.js></script><title>Using TinyML to identify farts | JimBobBennett</title></head><body class=light onload=loading()><header><nav class="pt-3 navbar navbar-expand-lg"><div class="container-fluid mx-xs-2 mx-sm-5 mx-md-5 mx-lg-5"><a class="navbar-brand primary-font text-wrap" href=/><img src=/fav.png width=30 height=30 class="d-inline-block align-top">
JimBobBennett
</a><button class=navbar-toggler type=button data-bs-toggle=collapse data-bs-target=#navbarContent aria-controls=navbarContent aria-expanded=false aria-label="Toggle navigation"><svg aria-hidden="true" height="24" viewBox="0 0 16 16" width="24" data-view-component="true"><path fill-rule="evenodd" d="M1 2.75A.75.75.0 011.75 2h12.5a.75.75.0 110 1.5H1.75A.75.75.0 011 2.75zm0 5A.75.75.0 011.75 7h12.5a.75.75.0 110 1.5H1.75A.75.75.0 011 7.75zM1.75 12a.75.75.0 100 1.5h12.5a.75.75.0 100-1.5H1.75z"/></svg></button><div class="collapse navbar-collapse text-wrap primary-font" id=navbarContent><ul class="navbar-nav ms-auto text-center"><li class="nav-item navbar-text"><a class=nav-link href=/ aria-label=home>Home</a></li><li class="nav-item navbar-text"><a class=nav-link href=/#about aria-label=about>About</a></li><li class="nav-item navbar-text"><a class=nav-link href=/#projects aria-label=projects>Recent Highlights</a></li><li class="nav-item navbar-text"><a class=nav-link href=/blogs title="Blog posts">Blog</a></li><li class="nav-item navbar-text"><a class=nav-link href=/videos title=Videos>Videos</a></li><li class="nav-item navbar-text"><a class=nav-link href=/podcasts title=Podcasts>Podcasts</a></li><li class="nav-item navbar-text"><a class=nav-link href=/livestreams title=Livestreams>Livestreams</a></li><li class="nav-item navbar-text"><a class=nav-link href=/conferences title=Conferences>Conferences</a></li><li class="nav-item navbar-text"><a class=nav-link href=/resume title=Resume>Resume</a></li></ul></div></div></nav></header><div id=content><section id=projects><div class="container pt-5" id=list-page><div class="row justify-content-center px-3 px-md-5"><h1 class="text-left pb-2 content">Using TinyML to identify farts</h1><div class="text-left content"><a href=https://linkedin.com/in/jimbobbennett>Jim Bennett
</a><small>|</small>
Feb 22, 2021</div></div></div></section><section id=single><div class=container><div class="row justify-content-center"><div class="col-sm-12 col-md-12 col-lg-9"><div class=pr-lg-4><article class="page-content p-2"><blockquote><p>TLDR; Find a complete hands-on lab to build a TinyML audio classifier at <a href=https://github.com/microsoft/iot-curriculum/tree/main/labs/tiny-ml/audio-classifier>github.com/microsoft/iot-curriculum/tree/main/labs/tiny-ml/audio-classifier</a>.</p></blockquote><p>My 8-year-old daughter bought me &ldquo;Farts - a spotters guide&rdquo; - a book with some buttons down the side and when you press them, they make different fart sounds. This is the height of humor for an 8 year old, and still pretty funny as an adult. I thought it would be fun to see if I could distinguish between the different fart noises using machine learning - and not just any machine learning, but seeing as I love IoT, I wanted it to run on a microcontroller!</p><p><img src=fart-book.jpg alt="Farts, a spotters guide"></p><h2 id=tinyml>TinyML</h2><p>TinyML is a relatively new field, and is all about creating tiny machine learning models that can run on microcontrollers. These models are really tiny - in the order of kilobytes instead of the usual megabytes or gigabytes. They need to be this tiny to run on microcontrollers that typically have kilobytes of RAM. These models also draw little power, typically in the single-digit milliwatts or lower.</p><p>What are the use cases for TinyML? Well there are loads, anywhere you want to run ML models offline with minimal power draw. You may even have some TinyML models running in your house right now. For example, smart voice controlled devices listen for a wake word, and this needs to be offline and draw minimal power - perfect for a TinyML model. Another use case is in healthcare with devices that can monitor your health that run for years on tiny batteries. It&rsquo;s also being used in animal smart collars and trackers, <a href=https://www.hackster.io/contests/ElephantEdge>using audio to monitor the health of elephants in the wild</a>. So yes - a fart detector has a real world application!</p><p>To build a TinyML model you need to decide what type of model to build, gather training data, train the model, then deploy it to your device to handle new data. In this case, I wanted an audio classifier, so decided to use a <a href=https://scikit-learn.org/stable/modules/svm.html>support vector machine classifier</a>.</p><blockquote><p>Despite this sounding all fancy and like I know what I&rsquo;m talking about, I actually have no clue what this is - I just learned about them from a great tutorial which I followed to get inspiration for this post! The tutorial is <a href=https://eloquentarduino.github.io/2020/08/better-word-classification-with-arduino-33-ble-sense-and-machine-learning/>Better word classification with Arduino Nano 33 BLE Sense and Machine Learning</a>.</p></blockquote><h2 id=building-a-fart-detector>Building a fart detector</h2><p>For my fart detector, I needed to build an audio classifier that could run on a microcontroller. Because I&rsquo;m terrible at electronics and understanding I2C, SPI and all that other stuff, I decided to use an all-in-one Arduino board that has a microphone built in allowing me to use off-the-shelf Arduino libraries to gather audio data. The board of choice was the Arduino Nano 33 Sense BLE board, a small Arduino board with a whole raft of sensors including a microphone, temperature, pressure, humidity, light level and color, gesture and proximity. That&rsquo;s a lot of sensors in such a tiny board!</p><p><img src=nano-sense.jpg alt="An arduino Nano sense 33 BLE IoT board"></p><p>To code this board, I could use the free Arduino IDE, but I prefer to use <a href=https://code.visualstudio.com/>Visual Studio Code</a>, along with the <a href=https://platformio.org/>PlatformIO extension</a>. This allows the creation of standalone microcontroller projects with .ini files that define the board and libraries used. I can check a project into GitHub and someone can clone it and immediately start working with it without the need for instructions on what boards and libraries they need to set up.</p><h3 id=getting-training-data>Getting training data</h3><p>To train TinyML models you not only need the model to by tiny, but you also need small inputs - the more data that goes into training the model or inference (that is running the model), the larger it is. Audio data can be quite large - for example CD quality audio (remember CDs?) is 44.1KHz/16-bit which means it captures 2 bytes of data 44,100 times per second, or 176KB per second! That&rsquo;s a lot of data - if we wanted to use all of it and train our model with 2 seconds worth of data it wouldn&rsquo;t be TinyML any more.</p><p>A great trick with audio data is realizing you don&rsquo;t need all of it to classify particular sounds. Instead you can get an average value that represents many samples and use that as the data. In the case of the Arduino, the library that captures audio, <a href=https://www.arduino.cc/en/Reference/PDM>PDM</a>, captures audio at 16KHz in 512 byte buffers, containing 256 2-byte samples. This means each buffer has 1/64th of a second of audio data in it. We can then calculate a root mean square (RMS) of all this data to get a single 4-byte floating point value. If we do this for every buffer, we end up with 64 4-byte floats per second, or 256 bytes per second. Much smaller than raw audio at the PDM sample rate of 16KHz giving 32,000 bytes per second!</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#75715e>#define BUFFER_SIZE 512U
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>...
</span></span><span style=display:flex><span><span style=color:#75715e>// Check we have a full buffers worth
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>if</span> (PDM.available() <span style=color:#f92672>==</span> BUFFER_SIZE)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#75715e>// Read from the buffer
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  PDM.read(_buffer, BUFFER_SIZE);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// Calculate the root mean square value of the buffer
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>int16_t</span> rms;
</span></span><span style=display:flex><span>  arm_rms_q15((q15_t <span style=color:#f92672>*</span>)_buffer, BUFFER_SIZE<span style=color:#f92672>/</span><span style=color:#66d9ef>sizeof</span>(<span style=color:#66d9ef>int16_t</span>), (q15_t <span style=color:#f92672>*</span>)<span style=color:#f92672>&amp;</span>rms);
</span></span><span style=display:flex><span>  ...
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>The RMS value can be checked against a threshold to see if there is actual audio data or not, and if audio data is detected, the next 2 seconds worth can be grabbed. In this case it&rsquo;s output to the serial port so it can be read from the PlatformIO serial monitor in VS Code.</p><p>You can find the full code to capture audio samples in the <a href=https://github.com/microsoft/iot-curriculum/tree/main/labs/tiny-ml/audio-classifier/code/audio-capture>Microsoft IoT Curriculum resource GitHub repo in the labs folder</a>.</p><h3 id=train-the-model>Train the model</h3><p>To train the model, we need a good range of audio data captured from the Arduino device - ideally 15-30 samples per audio we want to classify. A classifier distinguishes the input between multiple labels, so we need to gather data for multiple labels. For example, to classify the farts from my fart book I&rsquo;d need to gather 15-30 samples for at least 2 different farts.</p><p>The audio data sent to the serial monitor from the Arduino can be captured into .csv files, and these can be loaded by a Python script and used to train a model.</p><p>The model in question is trained using <a href=https://scikit-learn.org/>Scikit-Learn</a>, a Python Machine Learning library. The audio data is loaded into numpy arrays, then split into training and testing data, the model is trained using the training data, then tested with the testing data to give an idea on the accuracy.</p><blockquote><p>If you have a nice shiny Apple M1 mac (like I do), then installing Scikit-Learn is currently not as easy. Check out my <a href=/blogs/installing-scikit-learn-on-an-apple-m1/>guide on how to install it</a></p></blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#75715e># Split the data into a training and testing set to test the accuracy of the model
</span></span></span><span style=display:flex><span><span style=color:#75715e># If you are happy with the accuracy of the model, you can remove this split
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>dataset_train, dataset_test, label_train, label_test <span style=color:#f92672>=</span> train_test_split(dataset, dataset_labels.ravel(), test_size<span style=color:#f92672>=</span><span style=color:#ae81ff>0.2</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Build the support vector classification for our data and train the model
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>svc <span style=color:#f92672>=</span> SVC(kernel<span style=color:#f92672>=</span><span style=color:#960050;background-color:#1e0010>&#39;</span>poly<span style=color:#960050;background-color:#1e0010>&#39;</span>, degree<span style=color:#f92672>=</span><span style=color:#ae81ff>2</span>, gamma<span style=color:#f92672>=</span><span style=color:#ae81ff>0.1</span>, C<span style=color:#f92672>=</span><span style=color:#ae81ff>100</span>)
</span></span><span style=display:flex><span>svc.fit(dataset_train, label_train)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Test the accuracy of the model
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>print(<span style=color:#960050;background-color:#1e0010>&#39;</span>Accuracy:<span style=color:#960050;background-color:#1e0010>&#39;</span>, svc.score(dataset_test, label_test))
</span></span></code></pre></div><p>Once the model has been trained, it can be exported using the rather useful <a href=https://pypi.org/project/micromlgen/>micromlgen Python library</a> which can convert ML models into raw C++ code to run on microcontrollers.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span>from micromlgen import port
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span><span style=color:#75715e># Convert the model to C code and write to the classifier.h file
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>c_code <span style=color:#f92672>=</span> port(svc, classmap<span style=color:#f92672>=</span>label_map)
</span></span><span style=display:flex><span>with open(<span style=color:#960050;background-color:#1e0010>&#39;</span>classifier.h<span style=color:#960050;background-color:#1e0010>&#39;</span>, <span style=color:#e6db74>&#39;w&#39;</span>) as f:
</span></span><span style=display:flex><span>    f.write(c_code)
</span></span><span style=display:flex><span>    f.close()
</span></span></code></pre></div><p>You can find the training code in the <a href=https://github.com/microsoft/iot-curriculum/tree/main/labs/tiny-ml/audio-classifier/code/model-trainer>Microsoft IoT Curriculum resource GitHub repo in the labs folder</a>.</p><h2 id=classify-farts>Classify farts</h2><p>The C++ code that comes out of the training can then be added to the microcontroller code. Instead of dumping the audio data to the serial port, it can be sent to the classifier code, and the label of the best match is returned.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>processSamples</span>()
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#75715e>// Write out the classification to the serial port
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  Serial.print(<span style=color:#e6db74>&#34;Label: &#34;</span>);
</span></span><span style=display:flex><span>  Serial.println(clf.predictLabel(_samples));
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=learn-more>Learn more</h2><p>You can find a complete hands on lab implementing this in the <a href=https://github.com/microsoft/iot-curriculum/tree/main/labs/tiny-ml/audio-classifier>Microsoft IoT Curriculum resource GitHub repo in the labs folder</a>.</p></article></div></div><div class="col-sm-12 col-md-12 col-lg-3"><div class=sticky-sidebar><aside class=toc><h5>Table Of Contents</h5><div class=toc-content><nav id=TableOfContents><ul><li><a href=#tinyml>TinyML</a></li><li><a href=#building-a-fart-detector>Building a fart detector</a><ul><li><a href=#getting-training-data>Getting training data</a></li><li><a href=#train-the-model>Train the model</a></li></ul></li><li><a href=#classify-farts>Classify farts</a></li><li><a href=#learn-more>Learn more</a></li></ul></nav></div></aside><aside class=tags><h5>Tags</h5><ul class="tags-ul list-unstyled list-inline"><li class=list-inline-item><a href=https://jimbobbennett.dev/tags/ai target=_blank>ai</a></li><li class=list-inline-item><a href=https://jimbobbennett.dev/tags/iot target=_blank>iot</a></li><li class=list-inline-item><a href=https://jimbobbennett.dev/tags/tinyml target=_blank>tinyml</a></li><li class=list-inline-item><a href=https://jimbobbennett.dev/tags/vscode target=_blank>vscode</a></li><li class=list-inline-item><a href=https://jimbobbennett.dev/tags/platformio target=_blank>platformio</a></li></ul></aside></div></div></div><div class=row><div class="col-sm-12 col-md-12 col-lg-9 p-4"><div id=disqus_thread></div><script>var disqus_config=function(){this.page.url="https://jimbobbennett.dev/blogs/tiny-ml-farts/",this.page.identifier="fd25897e4d050893ced719f182685851"};(function(){if(window.location.hostname=="localhost")return;var e=document,t=e.createElement("script");t.src="https://jimbobbennett.disqus.com/embed.js",t.setAttribute("data-timestamp",+new Date),(e.head||e.body).appendChild(t)})()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript></div></div></div><button class="p-2 px-3" onclick=topFunction() id=topScroll>
<i class="fas fa-angle-up"></i></button></section><script>var topScroll=document.getElementById("topScroll");window.onscroll=function(){scrollFunction()};function scrollFunction(){document.body.scrollTop>20||document.documentElement.scrollTop>20?topScroll.style.display="block":topScroll.style.display="none"}function topFunction(){document.body.scrollTop=0,document.documentElement.scrollTop=0}</script></div><footer><div class="container py-4"><div class="row justify-content-center"><div class="col-md-4 text-center">&copy; 2024 All Rights Reserved</div></div></div></div></footer><script src=https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.min.js integrity=sha384-QJHtvGhmr9XOIpI6YVutG+2QOK9T+ZnN4kzFN1RtK3zEFEIsxhlmWl5/YESvpZ13 crossorigin=anonymous></script><script>document.body.className.includes("light")&&(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))</script><script>let loadingIcons;function loading(){myVar=setTimeout(showPage,100)}function showPage(){try{document.getElementById("loading-icons").style.display="block"}catch{}}</script><script>function createCopyButton(e,t){const n=document.createElement("button");n.className="copy-code-button",n.type="button",n.innerText="Copy",n.addEventListener("click",()=>copyCodeToClipboard(n,e,t)),addCopyButtonToDom(n,e)}async function copyCodeToClipboard(e,t,n){const s=t.querySelector("pre > code").innerText;try{n.writeText(s)}finally{codeWasCopied(e)}}function codeWasCopied(e){e.blur(),e.innerText="Copied!",setTimeout(function(){e.innerText="Copy"},2e3)}function addCopyButtonToDom(e,t){t.insertBefore(e,t.firstChild);const n=document.createElement("div");n.className="highlight-wrapper",t.parentNode.insertBefore(n,t),n.appendChild(t)}if(navigator&&navigator.clipboard)document.querySelectorAll(".highlight").forEach(e=>createCopyButton(e,navigator.clipboard));else{var script=document.createElement("script");script.src="https://cdnjs.cloudflare.com/ajax/libs/clipboard-polyfill/2.7.0/clipboard-polyfill.promise.js",script.integrity="sha256-waClS2re9NUbXRsryKoof+F9qc1gjjIhc2eT7ZbIv94=",script.crossOrigin="anonymous",script.onload=function(){addCopyButtons(clipboard)},document.querySelectorAll(".highlight").forEach(e=>createCopyButton(e,script)),document.body.appendChild(script)}</script></body></html>