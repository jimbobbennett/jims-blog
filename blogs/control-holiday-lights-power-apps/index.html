<!doctype html><html><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=X-UA-Compatible content="ie=edge"><link rel=icon href=/fav.png type=image/png><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=preload as=style href="https://fonts.googleapis.com/css2?family=Alata&family=Lora&family=Muli:ital,wght@0,400;0,500;0,600;0,700;1,400;1,500;1,600;1,700&family=Roboto&family=Muli:ital,wght@0,100;0,300;0,400;0,500;0,700;0,900;1,100;1,300;1,400;1,500;1,700;1,900&display=swap"><link rel=stylesheet href="https://fonts.googleapis.com/css2?family=Alata&family=Lora&family=Muli:ital,wght@0,400;0,500;0,600;0,700;1,400;1,500;1,600;1,700&family=Roboto&family=Muli:ital,wght@0,100;0,300;0,400;0,500;0,700;0,900;1,100;1,300;1,400;1,500;1,700;1,900&display=swap" media=print onload='this.media="all"'><noscript><link href="https://fonts.googleapis.com/css2?family=Alata&family=Lora&family=Muli:ital,wght@0,400;0,500;0,600;0,700;1,400;1,500;1,600;1,700&family=Roboto&family=Muli:ital,wght@0,100;0,300;0,400;0,500;0,700;0,900;1,100;1,300;1,400;1,500;1,700;1,900&display=swap" rel=stylesheet></noscript><link rel=stylesheet href=/css/font.css media=all><meta property="og:title" content="Control holiday lights with Python, Azure IoT and Power Apps"><meta property="og:description" content="Well this year I decided to build IoT powered holiday lights, controlled by a Power App built with no code!"><meta property="og:type" content="article"><meta property="og:url" content="https://jimbobbennett.dev/blogs/control-holiday-lights-power-apps/"><meta property="og:image" content="https://jimbobbennett.dev/blogs/control-holiday-lights-power-apps/app-controlled-lights.gif"><meta property="article:section" content="blogs"><meta property="article:published_time" content="2020-11-13T00:00:00+00:00"><meta property="article:modified_time" content="2020-11-13T00:00:00+00:00"><meta property="og:site_name" content="JimBobBennett"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://jimbobbennett.dev/blogs/control-holiday-lights-power-apps/app-controlled-lights.gif"><meta name=twitter:title content="Control holiday lights with Python, Azure IoT and Power Apps"><meta name=twitter:description content="Well this year I decided to build IoT powered holiday lights, controlled by a Power App built with no code!"><meta name=twitter:site content="@jimbobbennett"><meta name=twitter:creator content="@jimbobbennett"><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css integrity=sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3 crossorigin=anonymous><link rel=stylesheet href=/css/header.css media=all><link rel=stylesheet href=/css/footer.css media=all><link rel=stylesheet href=/css/theme.css media=all><link rel="shortcut icon" type=image/png href=/fav.png><link rel="shortcut icon" sizes=192x192 href=/fav.png><link rel=apple-touch-icon href=/fav.png><link rel=alternate type=application/rss+xml href=https://jimbobbennett.dev//index.xml title=JimBobBennett><script type=text/javascript>(function(e,t,n,s,o,i,a){e[n]=e[n]||function(){(e[n].q=e[n].q||[]).push(arguments)},i=t.createElement(s),i.async=1,i.src="https://www.clarity.ms/tag/"+o,a=t.getElementsByTagName(s)[0],a.parentNode.insertBefore(i,a)})(window,document,"clarity","script","dctc2ydykv")</script><script data-goatcounter=https://jimbobbennett.goatcounter.com/count async src=//gc.zgo.at/count.js></script><style>:root{--text-color:#343a40;--text-secondary-color:#6c757d;--background-color:#000;--secondary-background-color:#64ffda1a;--primary-color:#007bff;--secondary-color:#f8f9fa;--text-color-dark:#e4e6eb;--text-secondary-color-dark:#b0b3b8;--background-color-dark:#000000;--secondary-background-color-dark:#212529;--primary-color-dark:#ffffff;--secondary-color-dark:#212529}body{background-color:#000;font-size:1rem;font-weight:400;line-height:1.5;text-align:left}</style><meta name=description content="Well this year I decided to build IoT powered holiday lights, controlled by a Power App built with no code!"><link rel=stylesheet href=/css/index.css><link rel=stylesheet href=/css/single.css><link rel=stylesheet href=/css/projects.css media=all><script defer src=/fontawesome-5/all-5.15.4.js></script><title>Control holiday lights with Python, Azure IoT and Power Apps | JimBobBennett</title></head><body class=light onload=loading()><header><nav class="pt-3 navbar navbar-expand-lg"><div class="container-fluid mx-xs-2 mx-sm-5 mx-md-5 mx-lg-5"><a class="navbar-brand primary-font text-wrap" href=/><img src=/fav.png width=30 height=30 class="d-inline-block align-top">
JimBobBennett
</a><button class=navbar-toggler type=button data-bs-toggle=collapse data-bs-target=#navbarContent aria-controls=navbarContent aria-expanded=false aria-label="Toggle navigation"><svg aria-hidden="true" height="24" viewBox="0 0 16 16" width="24" data-view-component="true"><path fill-rule="evenodd" d="M1 2.75A.75.75.0 011.75 2h12.5a.75.75.0 110 1.5H1.75A.75.75.0 011 2.75zm0 5A.75.75.0 011.75 7h12.5a.75.75.0 110 1.5H1.75A.75.75.0 011 7.75zM1.75 12a.75.75.0 100 1.5h12.5a.75.75.0 100-1.5H1.75z"/></svg></button><div class="collapse navbar-collapse text-wrap primary-font" id=navbarContent><ul class="navbar-nav ms-auto text-center"><li class="nav-item navbar-text"><a class=nav-link href=/ aria-label=home>Home</a></li><li class="nav-item navbar-text"><a class=nav-link href=/#about aria-label=about>About</a></li><li class="nav-item navbar-text"><a class=nav-link href=/#projects aria-label=projects>Recent Highlights</a></li><li class="nav-item navbar-text"><a class=nav-link href=/blogs title="Blog posts">Blog</a></li><li class="nav-item navbar-text"><a class=nav-link href=/videos title=Videos>Videos</a></li><li class="nav-item navbar-text"><a class=nav-link href=/podcasts title=Podcasts>Podcasts</a></li><li class="nav-item navbar-text"><a class=nav-link href=/livestreams title=Livestreams>Livestreams</a></li><li class="nav-item navbar-text"><a class=nav-link href=/conferences title=Conferences>Conferences</a></li><li class="nav-item navbar-text"><a class=nav-link href=/resume title=Resume>Resume</a></li></ul></div></div></nav></header><div id=content><section id=projects><div class="container pt-5" id=list-page><div class="row justify-content-center px-3 px-md-5"><h1 class="text-left pb-2 content">Control holiday lights with Python, Azure IoT and Power Apps</h1><div class="text-left content"><a href=https://linkedin.com/in/jimbobbennett>Jim Bennett
</a><small>|</small>
Nov 13, 2020</div></div></div></section><section id=single><div class=container><div class="row justify-content-center"><div class="col-sm-12 col-md-12 col-lg-9"><div class=pr-lg-4><article class="page-content p-2"><p>As the nights draw in here in the northern hemisphere, there are a number of winter celebrations that happen - and one thing they all have in common is lights.</p><p>In the past I&rsquo;ve just purchased strings of lights from the nearest retailer, strung them up to a tree or around my house, and fought with remote controls or buttons to get the color I wanted.</p><p>Well this year I decided to do something better and build IoT powered holiday lights, controlled by a Power App built with no code!</p><p><img src=app-controlled-lights.gif alt="Lights controlled by a power app"></p><p>The hardware would be based around <a href=https://www.amazon.com/gp/product/B07FVPN3PH>WS2812B programmable LED strips (also referred to as Neopixels)</a>, controlled by a <a href=https://www.raspberrypi.org/products/raspberry-pi-zero-w>Raspberry Pi Zero W</a>. Software wise, the Pi would run some Python code to talk to <a href=https://azure.microsoft.com/services/iot-central>Azure IoT Central</a> - an IoT software as a service platform that can send commands to the Pi to turn the lights on or off. A <a href=https://powerapps.microsoft.com/>Power App</a> would then be used to control IoT Central via a mobile app - written with no code! All these cloud services can be used for free, which is even better!</p><blockquote><p>You can find a full hands-on guide to building this your self with detailed instructions and all the code in my <a href=https://github.com/jimbobbennett/NeopixelHolidayLights>Neopixel Holiday Lights GitHub Repo</a></p></blockquote><h2 id=hardware-needed>Hardware needed</h2><p>To create this, you will need the following hardware:</p><ul><li>A Raspberry Pi that can connect to the internet such as a Pi Zero W or a Pi 3/4, with appropriate SD card and power supply</li><li>A strip of WS212B programmable LEDs</li><li>A 5v power supply - either a USB to terminal block lead or a 5v DC converter</li><li>Jumper wires</li></ul><p>To wire the hardware, connect the positive lead or pin on the LEDs to the positive terminal on the 5v power supply, Connect the negative lead or pin to both the negative terminal on the power supply, and a GND GPIO pin on the Raspberry Pi. Some LED strips have twin negative leads for this reason, otherwise you&rsquo;ll need to solder or attach more leads as necessary. Finally attach the control pin to GPIO pin 18 on the Raspberry Pi. You can find details on the pin numbers in the <a href=https://www.raspberrypi.org/documentation/usage/gpio/>Raspberry Pi GPIO documentation</a>.</p><p><img src=wiring-1.png alt="The wiring of the neo pixels"></p><h2 id=azure-iot-central>Azure IoT Central</h2><p><a href=https://azure.microsoft.com/services/iot-central>Azure IoT Central</a> is a software as a services platform that allows you to build the cloud infrastructure and security for your IoT apps with no code. It is based around device templates - a description of the data that a device can send to the cloud, and commands the cloud can send to the device to instruct it to do something.</p><p>Start by heading to <a href=https://apps.azureiotcentral.com/>apps.azureiotcentral.com</a> and creating a new app. Although IoT Central is a paid service, you can use it for free. There is a free tier, but apps created using this are deleted after 7 days, so go for one of the standard tiers. Both the standard tiers offer 2 devices for free, so you can control your Pi without paying anything.</p><p>You will need an Azure Subscription to sign up, so if you don&rsquo;t have one you can sign up for free. Students can sign up at <a href=https://azure.microsoft.com/free/students/>azure.microsoft.com/free/students</a> to get $100 of credit for a year, renewing every year, otherwise sign up at <a href=https://azure.microsoft.com/free/>azure.microsoft.com/free</a> to get $200 of credit that lasts 30 days.</p><p>Once you have your app created, create a device template with 2 commands and a property. The commands will turn the lights on and off, and the property will allow the color to be persisted so restarting the Pi means the lights will re-light with the last color set.</p><p>Name one of the commands <code>On</code> and make it take a request parameter called <code>Color</code>. Name the other command <code>Off</code> with no request parameter. Create the property called <code>Color</code> as a <code>string</code>. Publish this template, then create a new device using it. Once you&rsquo;ve created the device, grab the connection details.</p><h2 id=program-the-pi>Program the Pi</h2><p>Next step is to program the Pi to connect to IoT Central, receive the commands and turn on the lights. This can be done in Python. Make sure your Pi is using the latest Raspberry Pi OS, with all the latest updates and is connected to the internet. You can use either the Lite or Desktop version - for a project like this where the Pi is running headless I like to use the Lite version to allow me to use smaller SD cards and boot the Pis faster.</p><blockquote><p>To program the Pi, you can use your favorite Python tool. I personally recommend using <a href=https://code.visualstudio.com/>Visual Studio Code</a>, a free, open source developer text editor that has extensions for a variety of languages, including the <a href=https://devblogs.microsoft.com/python/announcing-pylance-fast-feature-rich-language-support-for-python-in-visual-studio-code/>PyLance extension for Python</a>. If you are using the full desktop version of Raspberry Pi OS, you can <a href=/blogs/run-visual-studio-code-on-a-raspberry-pi>install VS Code locally</a>, otherwise use the <a href=https://code.visualstudio.com/docs/remote/ssh>Remote SSH extension</a> to code remotely on a Pi 3 or 4, or the <a href="https://marketplace.visualstudio.com/items?itemName=Kelvin.vscode-sshfs">SSH File system extension</a> to code remotely on a Pi Zero.</p></blockquote><p>First you need to install some Pip packages. These need to be installed using <code>sudo</code> - to control the Neopixels you need to run the code as a super user. Install the following:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>rpi_ws281x 
</span></span><span style=display:flex><span>adafruit-circuitpython-neopixel
</span></span><span style=display:flex><span>azure-iot-device
</span></span><span style=display:flex><span>python-dotenv
</span></span></code></pre></div><p>The first 2 packages provide control for the LEDs, the <code>azure-iot-device</code> package has the Python code for devices to connect to IoT Central, and <code>python-dotenv</code> is used to load secrets from .env files to avoid things like API keys being uploaded to source code control.</p><p>Once these are installed, create a file called <code>.env</code> on the Pi in whatever folder you want to create the code in to store the connection details for the IoT Central device, and add the following:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=display:flex><span><span style=color:#a6e22e>ID_SCOPE</span><span style=color:#f92672>=</span><span style=color:#e6db74>&lt;ID scope&gt;</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>DEVICE_ID</span><span style=color:#f92672>=</span><span style=color:#e6db74>&lt;device id&gt;</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>PRIMARY_KEY</span><span style=color:#f92672>=</span><span style=color:#e6db74>&lt;primary key&gt;</span>
</span></span></code></pre></div><p>Replace <code>&lt;ID scope></code> with the value of the ID Scope from the IoT Central device connection dialog. Replace <code>&lt;device id></code> with the device ID, and the <code>&lt;primary key></code> with the primary key.</p><p>Next create a file called <code>app.py</code> and add the following code. You can also find this code in <a href=https://github.com/jimbobbennett/NeopixelHolidayLights/blob/main/code/iot-controlled/app.py>the GitHub repo tha accompanies this post</a>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>import</span> asyncio
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> board
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> neopixel
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> os
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> azure.iot.device.aio <span style=color:#f92672>import</span> IoTHubDeviceClient, ProvisioningDeviceClient
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> azure.iot.device <span style=color:#f92672>import</span> MethodResponse
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> dotenv <span style=color:#f92672>import</span> load_dotenv
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Define the NeoPixel strip setting:</span>
</span></span><span style=display:flex><span><span style=color:#75715e># The pin the control wire is connected to (18 in this code)</span>
</span></span><span style=display:flex><span><span style=color:#75715e># The length of the strip (150 LEDs in this code)</span>
</span></span><span style=display:flex><span><span style=color:#75715e># The brightness (0.2 on a scale of 0-1)</span>
</span></span><span style=display:flex><span><span style=color:#75715e># If the colors are written as soon as the values are updated, or if they need to be</span>
</span></span><span style=display:flex><span><span style=color:#75715e># updated all at once as soon as the values are set</span>
</span></span><span style=display:flex><span>pixels <span style=color:#f92672>=</span> neopixel<span style=color:#f92672>.</span>NeoPixel(board<span style=color:#f92672>.</span>D18, <span style=color:#ae81ff>150</span>, brightness<span style=color:#f92672>=</span><span style=color:#ae81ff>0.2</span>, auto_write<span style=color:#f92672>=</span><span style=color:#66d9ef>False</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Load the IoT Central connection details from a .env file</span>
</span></span><span style=display:flex><span>load_dotenv()
</span></span><span style=display:flex><span>id_scope <span style=color:#f92672>=</span> os<span style=color:#f92672>.</span>getenv(<span style=color:#e6db74>&#39;ID_SCOPE&#39;</span>)
</span></span><span style=display:flex><span>device_id <span style=color:#f92672>=</span> os<span style=color:#f92672>.</span>getenv(<span style=color:#e6db74>&#39;DEVICE_ID&#39;</span>)
</span></span><span style=display:flex><span>primary_key <span style=color:#f92672>=</span> os<span style=color:#f92672>.</span>getenv(<span style=color:#e6db74>&#39;PRIMARY_KEY&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Declare the device client so it can be used from all the function</span>
</span></span><span style=display:flex><span>device_client <span style=color:#f92672>=</span> <span style=color:#66d9ef>None</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Provisions the device with the Azure device provisioning service or returns</span>
</span></span><span style=display:flex><span><span style=color:#75715e># the connection details if the device is already provisioned</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>async</span> <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>register_device</span>():
</span></span><span style=display:flex><span>    provisioning_device_client <span style=color:#f92672>=</span> ProvisioningDeviceClient<span style=color:#f92672>.</span>create_from_symmetric_key(
</span></span><span style=display:flex><span>        provisioning_host<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;global.azure-devices-provisioning.net&#39;</span>,
</span></span><span style=display:flex><span>        registration_id<span style=color:#f92672>=</span>device_id,
</span></span><span style=display:flex><span>        id_scope<span style=color:#f92672>=</span>id_scope,
</span></span><span style=display:flex><span>        symmetric_key<span style=color:#f92672>=</span>primary_key,
</span></span><span style=display:flex><span>    )
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>await</span> provisioning_device_client<span style=color:#f92672>.</span>register()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Sets the color of the Neopixels based on a color string coming in.</span>
</span></span><span style=display:flex><span><span style=color:#75715e># This color string is a 6 character code, 2 characters for red, 2 for green</span>
</span></span><span style=display:flex><span><span style=color:#75715e># and 2 for blue. These 2 characters are a HEX value from 00 to FF.</span>
</span></span><span style=display:flex><span><span style=color:#75715e># For example FF0000 is full red, no green or blue. FFFFFF is white, 000000 is off.</span>
</span></span><span style=display:flex><span><span style=color:#75715e># Once the color is set, write it back to the IoT Central property via a device twin</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>async</span> <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>set_color</span>(color):
</span></span><span style=display:flex><span>    <span style=color:#75715e># split in the color string into the red, green and blue components, and convert these</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># to valid hex strings</span>
</span></span><span style=display:flex><span>    r <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;0x&#39;</span> <span style=color:#f92672>+</span> color[<span style=color:#ae81ff>0</span>:<span style=color:#ae81ff>2</span>]
</span></span><span style=display:flex><span>    g <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;0x&#39;</span> <span style=color:#f92672>+</span> color[<span style=color:#ae81ff>2</span>:<span style=color:#ae81ff>4</span>]
</span></span><span style=display:flex><span>    b <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;0x&#39;</span> <span style=color:#f92672>+</span> color[<span style=color:#ae81ff>4</span>:<span style=color:#ae81ff>6</span>]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># Convert hext to numerical values</span>
</span></span><span style=display:flex><span>    r_value <span style=color:#f92672>=</span> int(r, <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>    g_value <span style=color:#f92672>=</span> int(g, <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>    b_value <span style=color:#f92672>=</span> int(b, <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    print(<span style=color:#e6db74>&#39;Updating color: r =&#39;</span>, r_value, <span style=color:#e6db74>&#39;, g =&#39;</span>, g_value, <span style=color:#e6db74>&#39;, b =&#39;</span>, b_value)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># Set all the pixels to the new color</span>
</span></span><span style=display:flex><span>    pixels<span style=color:#f92672>.</span>fill((r_value, g_value, b_value))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># Show the color on all the pixels</span>
</span></span><span style=display:flex><span>    pixels<span style=color:#f92672>.</span>show()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># Write the color back as a property</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># Properties are written to the device twin, so patch the reported properties</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># with the color</span>
</span></span><span style=display:flex><span>    patch <span style=color:#f92672>=</span> {<span style=color:#e6db74>&#39;Color&#39;</span>:color}
</span></span><span style=display:flex><span>    print(<span style=color:#e6db74>&#34;Sending patch:&#34;</span>, patch)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>await</span> device_client<span style=color:#f92672>.</span>patch_twin_reported_properties(patch)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># IoT Central command handler</span>
</span></span><span style=display:flex><span><span style=color:#75715e># IoT Central commands are implemented as IoT Hub direct methods</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>async</span> <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>command_handler</span>(method_request):
</span></span><span style=display:flex><span>    print(<span style=color:#e6db74>&#34;Message received:&#34;</span>, method_request<span style=color:#f92672>.</span>name)
</span></span><span style=display:flex><span>    print(<span style=color:#e6db74>&#34;Message payload:&#34;</span>, method_request<span style=color:#f92672>.</span>payload)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># Determine how to respond to the command based on the IoT Hub direct method method name</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># which is the same as the IoT Central command name</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> method_request<span style=color:#f92672>.</span>name <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;On&#34;</span>:
</span></span><span style=display:flex><span>        <span style=color:#75715e># For an On request, set the color based on the payload</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>await</span> set_color(method_request<span style=color:#f92672>.</span>payload)
</span></span><span style=display:flex><span>        print(<span style=color:#e6db74>&#34;executed on&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>elif</span> method_request<span style=color:#f92672>.</span>name <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;Off&#34;</span>:
</span></span><span style=display:flex><span>        <span style=color:#75715e># For an Off request, set the color to 000000, which turns the pixels off</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>await</span> set_color(<span style=color:#e6db74>&#34;000000&#34;</span>)
</span></span><span style=display:flex><span>        print(<span style=color:#e6db74>&#34;executed off&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>else</span>:
</span></span><span style=display:flex><span>        print(<span style=color:#e6db74>&#34;Received unknown method: &#34;</span> <span style=color:#f92672>+</span> method_request<span style=color:#f92672>.</span>name)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># Method calls have to return a response so IoT Central knows it was handled correctly,</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># So send a 200 response to show we handled this</span>
</span></span><span style=display:flex><span>    payload <span style=color:#f92672>=</span> {<span style=color:#e6db74>&#34;result&#34;</span>: <span style=color:#66d9ef>True</span>}
</span></span><span style=display:flex><span>    status <span style=color:#f92672>=</span> <span style=color:#ae81ff>200</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># Send the response</span>
</span></span><span style=display:flex><span>    method_response <span style=color:#f92672>=</span> MethodResponse<span style=color:#f92672>.</span>create_from_method_request(method_request, status, payload)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>await</span> device_client<span style=color:#f92672>.</span>send_method_response(method_response)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>async</span> <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>property_handler</span>(patch):
</span></span><span style=display:flex><span>    print(<span style=color:#e6db74>&#34;Patch received:&#34;</span>, patch)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#e6db74>&#39;Color&#39;</span> <span style=color:#f92672>in</span> patch:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>await</span> set_color(patch[<span style=color:#e6db74>&#39;Color&#39;</span>])
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># The main async function that runs the app</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>async</span> <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>main</span>():
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>global</span> device_client
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># Regsiter the Pi as an IoT device in IoT Central</span>
</span></span><span style=display:flex><span>    registration_result <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> register_device()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># Build the IoT Hub connection string from the registration details</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># IoT Central sits on top of IoT Hub, and the Python SDK only supports IoT Hub,</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># So to talk to IoT central the IoT Hub connection string needs to be built from details</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># from registering the device with the provisioning service</span>
</span></span><span style=display:flex><span>    conn_str<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;HostName=&#39;</span> <span style=color:#f92672>+</span> registration_result<span style=color:#f92672>.</span>registration_state<span style=color:#f92672>.</span>assigned_hub <span style=color:#f92672>+</span> \
</span></span><span style=display:flex><span>                <span style=color:#e6db74>&#39;;DeviceId=&#39;</span> <span style=color:#f92672>+</span> device_id <span style=color:#f92672>+</span> \
</span></span><span style=display:flex><span>                <span style=color:#e6db74>&#39;;SharedAccessKey=&#39;</span> <span style=color:#f92672>+</span> primary_key
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># The client object is used to interact with your Azure IoT Central app via IoT Hub, so create this </span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># from the connection string</span>
</span></span><span style=display:flex><span>    device_client <span style=color:#f92672>=</span> IoTHubDeviceClient<span style=color:#f92672>.</span>create_from_connection_string(conn_str)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># Connect the client to IoT Hub</span>
</span></span><span style=display:flex><span>    print(<span style=color:#e6db74>&#39;Connecting&#39;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>await</span> device_client<span style=color:#f92672>.</span>connect()
</span></span><span style=display:flex><span>    print(<span style=color:#e6db74>&#39;Connected&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># IoT Central stores properties in the device twin, so read this to see if we have a color</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># stored from the last run for the lights. This way when the device starts up it can set the color</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># to the last setting</span>
</span></span><span style=display:flex><span>    twin <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> device_client<span style=color:#f92672>.</span>get_twin()
</span></span><span style=display:flex><span>    print(<span style=color:#e6db74>&#39;Got twin: &#39;</span>, twin)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># Load the color from the reported properties of the twin if it exists</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#e6db74>&#39;reported&#39;</span> <span style=color:#f92672>in</span> twin <span style=color:#f92672>and</span> <span style=color:#e6db74>&#39;Color&#39;</span> <span style=color:#f92672>in</span> twin[<span style=color:#e6db74>&#39;reported&#39;</span>]:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>await</span> set_color(twin[<span style=color:#e6db74>&#39;reported&#39;</span>][<span style=color:#e6db74>&#39;Color&#39;</span>])
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># Set the method request handler on the client to handle IoT Central commands</span>
</span></span><span style=display:flex><span>    device_client<span style=color:#f92672>.</span>on_method_request_received <span style=color:#f92672>=</span> command_handler
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># Handle updates to the color property from IoT Central</span>
</span></span><span style=display:flex><span>    device_client<span style=color:#f92672>.</span>on_twin_desired_properties_patch_received <span style=color:#f92672>=</span> property_handler
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># Define a message loop that keeps the app alive whilst listening for commands</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>async</span> <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>main_loop</span>():
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>while</span> <span style=color:#66d9ef>True</span>:
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>await</span> asyncio<span style=color:#f92672>.</span>sleep(<span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># Wait for user to indicate they are done listening for method calls</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>await</span> main_loop()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># Finally, disconnect</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>await</span> device_client<span style=color:#f92672>.</span>disconnect()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Start the async app running</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> __name__ <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;__main__&#34;</span>:
</span></span><span style=display:flex><span>    asyncio<span style=color:#f92672>.</span>run(main())
</span></span></code></pre></div><p>Read the code and the comments to see what it does.</p><p>This code will connect to the Azure device provisioning service to authenticate the device using the settings from the <code>.env</code> file, then connect. It will load the properties to see if a color has already been set, and if so set the Neopixels to that color. It will then listen for commands to change the color of the Neopixels or turn them off.</p><p>Run the code as sudo with the following command:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo python3 app.py
</span></span></code></pre></div><p>The app will start up and connect. You can then run the commands in IoT Central to control the lights.</p><p>The color for the On command should be given as a string value representing a Hex string. It will be 6 characters long, with 2 characters each representing the R, G and B values with values from 0-255 (<code>00</code> - <code>FF</code>). For example, red is <code>FF0000</code>, green is <code>00FF00</code>, blue is <code>0000FF</code>, yellow is <code>FFFF00</code>, white is <code>FFFFFF</code>.</p><h2 id=set-up-a-power-app>Set up a Power App</h2><p>Power Apps allow you to build apps with low or no code, by creating flows that connect logic and services, and connecting these to a UI designed on a canvas.</p><p>You will need a Power Apps account to create one, and if you don&rsquo;t have one you can sign up for a <a href=https://powerapps.microsoft.com/communityplan/>community plan</a>. This will give you a free environment for learning and building your own apps.</p><p>Start by creating a flow in the Power App. This should use the <strong>Create from Template</strong> option selecting <strong>Power Apps button</strong>. Name this flow <code>Turn lights on</code> and add an <em>Azure IoT Central V3</em> connector (<strong>NOT</strong> the V2 connector). Select your IoT Central app, add the device id, set the device template, select the capability, then select the <em>On</em> command. A new box will appear for the color to pass to this command, so select this box and select <strong>Ask in Power Apps</strong> from the box that appears. Then save the flow.</p><p><img src=on-flow-complete.png alt="The complete on flow"></p><p>Create another flow for the <em>Off</em> command called <code>Turn lights off</code>.</p><p>Once you have the flows, create an app, Drag a text input and two buttons to the canvas and align then in a column.</p><p>Name the text input <code>ColorInput</code>, remove the default value and change the hint to color.</p><p>Name one button <code>On</code> and select the <strong>Action</strong> tab on the ribbon, then select <strong>Power Automate</strong>. From the popup, select the <em>Turn lights on</em> flow. It will take a few seconds to add the flow. When it does a half complete function will appear in the function bar. Pass the <code>Text</code> property of the <code>ColorInput</code> control into:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span>PowerAppsbutton.Run(ColorInput.Text)
</span></span></code></pre></div><p>Name the other button <code>Off</code> and add the <em>Turn lights off</em> flow to it. The function for this doesn&rsquo;t need any parameters, so just close the brackets.</p><p><img src=power-app-canvas.png alt="The complete power apps canvas"></p><p>Make sure the app is running on the Pi, then save and test the Power App using the <strong>Preview this app</strong> button on the toolbar.</p><h2 id=done>Done!</h2><p>Your app is now complete! Mount the lights somewhere and control them from the Power App. You can you can run it on your phone. Install the <strong>Power Apps</strong> app from the <a href=https://apps.apple.com/us/app/power-apps/id1047318566>Apple App Store</a> or <a href="https://play.google.com/store/apps/details?id=com.microsoft.msapps">Google Play Store</a>, log in, select your app and use it to control your lights.</p><h2 id=learn-more>Learn more</h2><p>You can learn more about Azure IoT Central and the Microsoft Power Platform via Microsoft Learn, a hands-on, self-guided learning platform from Microsoft.</p><ul><li><a href=https://docs.microsoft.com/learn/paths/develop-iot-solutions-with-azure-iot-central>Develop IoT Central applications with IoT Central</a></li><li><a href=https://docs.microsoft.com/learn/paths/power-plat-fundamentals/>Microsoft Power Platform Fundamentals</a></li></ul></article></div></div><div class="col-sm-12 col-md-12 col-lg-3"><div class=sticky-sidebar><aside class=toc><h5>Table Of Contents</h5><div class=toc-content><nav id=TableOfContents><ul><li><a href=#hardware-needed>Hardware needed</a></li><li><a href=#azure-iot-central>Azure IoT Central</a></li><li><a href=#program-the-pi>Program the Pi</a></li><li><a href=#set-up-a-power-app>Set up a Power App</a></li><li><a href=#done>Done!</a></li><li><a href=#learn-more>Learn more</a></li></ul></nav></div></aside><aside class=tags><h5>Tags</h5><ul class="tags-ul list-unstyled list-inline"><li class=list-inline-item><a href=https://jimbobbennett.dev/tags/iotcentral target=_blank>iotcentral</a></li><li class=list-inline-item><a href=https://jimbobbennett.dev/tags/iot target=_blank>iot</a></li><li class=list-inline-item><a href=https://jimbobbennett.dev/tags/azure target=_blank>azure</a></li><li class=list-inline-item><a href=https://jimbobbennett.dev/tags/raspberrypi target=_blank>raspberrypi</a></li><li class=list-inline-item><a href=https://jimbobbennett.dev/tags/lights target=_blank>lights</a></li><li class=list-inline-item><a href=https://jimbobbennett.dev/tags/powerapps target=_blank>powerapps</a></li><li class=list-inline-item><a href=https://jimbobbennett.dev/tags/powerplatform target=_blank>powerplatform</a></li></ul></aside></div></div></div><div class=row><div class="col-sm-12 col-md-12 col-lg-9 p-4"><div id=disqus_thread></div><script>var disqus_config=function(){this.page.url="https://jimbobbennett.dev/blogs/control-holiday-lights-power-apps/",this.page.identifier="ccff5756da9f74df6230e0901d9abee8"};(function(){if(window.location.hostname=="localhost")return;var e=document,t=e.createElement("script");t.src="https://jimbobbennett.disqus.com/embed.js",t.setAttribute("data-timestamp",+new Date),(e.head||e.body).appendChild(t)})()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript></div></div></div><button class="p-2 px-3" onclick=topFunction() id=topScroll>
<i class="fas fa-angle-up"></i></button></section><script>var topScroll=document.getElementById("topScroll");window.onscroll=function(){scrollFunction()};function scrollFunction(){document.body.scrollTop>20||document.documentElement.scrollTop>20?topScroll.style.display="block":topScroll.style.display="none"}function topFunction(){document.body.scrollTop=0,document.documentElement.scrollTop=0}</script></div><footer><div class="container py-4"><div class="row justify-content-center"><div class="col-md-4 text-center">&copy; 2024 All Rights Reserved</div></div></div></div></footer><script src=https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.min.js integrity=sha384-QJHtvGhmr9XOIpI6YVutG+2QOK9T+ZnN4kzFN1RtK3zEFEIsxhlmWl5/YESvpZ13 crossorigin=anonymous></script><script>document.body.className.includes("light")&&(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))</script><script>let loadingIcons;function loading(){myVar=setTimeout(showPage,100)}function showPage(){try{document.getElementById("loading-icons").style.display="block"}catch{}}</script><script>function createCopyButton(e,t){const n=document.createElement("button");n.className="copy-code-button",n.type="button",n.innerText="Copy",n.addEventListener("click",()=>copyCodeToClipboard(n,e,t)),addCopyButtonToDom(n,e)}async function copyCodeToClipboard(e,t,n){const s=t.querySelector("pre > code").innerText;try{n.writeText(s)}finally{codeWasCopied(e)}}function codeWasCopied(e){e.blur(),e.innerText="Copied!",setTimeout(function(){e.innerText="Copy"},2e3)}function addCopyButtonToDom(e,t){t.insertBefore(e,t.firstChild);const n=document.createElement("div");n.className="highlight-wrapper",t.parentNode.insertBefore(n,t),n.appendChild(t)}if(navigator&&navigator.clipboard)document.querySelectorAll(".highlight").forEach(e=>createCopyButton(e,navigator.clipboard));else{var script=document.createElement("script");script.src="https://cdnjs.cloudflare.com/ajax/libs/clipboard-polyfill/2.7.0/clipboard-polyfill.promise.js",script.integrity="sha256-waClS2re9NUbXRsryKoof+F9qc1gjjIhc2eT7ZbIv94=",script.crossOrigin="anonymous",script.onload=function(){addCopyButtons(clipboard)},document.querySelectorAll(".highlight").forEach(e=>createCopyButton(e,script)),document.body.appendChild(script)}</script></body></html>