<!doctype html><html><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=X-UA-Compatible content="ie=edge"><link rel=icon href=/fav.png type=image/png><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=preload as=style href="https://fonts.googleapis.com/css2?family=Alata&family=Lora&family=Muli:ital,wght@0,400;0,500;0,600;0,700;1,400;1,500;1,600;1,700&family=Roboto&family=Muli:ital,wght@0,100;0,300;0,400;0,500;0,700;0,900;1,100;1,300;1,400;1,500;1,700;1,900&display=swap"><link rel=stylesheet href="https://fonts.googleapis.com/css2?family=Alata&family=Lora&family=Muli:ital,wght@0,400;0,500;0,600;0,700;1,400;1,500;1,600;1,700&family=Roboto&family=Muli:ital,wght@0,100;0,300;0,400;0,500;0,700;0,900;1,100;1,300;1,400;1,500;1,700;1,900&display=swap" media=print onload='this.media="all"'><noscript><link href="https://fonts.googleapis.com/css2?family=Alata&family=Lora&family=Muli:ital,wght@0,400;0,500;0,600;0,700;1,400;1,500;1,600;1,700&family=Roboto&family=Muli:ital,wght@0,100;0,300;0,400;0,500;0,700;0,900;1,100;1,300;1,400;1,500;1,700;1,900&display=swap" rel=stylesheet></noscript><link rel=stylesheet href=/css/font.css media=all><meta property="og:title" content="Raspberry Pi cloud-connected Hat Cam"><meta property="og:description" content="This project builds a wearable, cloud connected camera. This is useful in situations where you want a record of what the camera sees stored in the cloud as quickly as possible. Make sure you use this in compliance will all applicable laws and privacy considerations."><meta property="og:type" content="article"><meta property="og:url" content="https://jimbobbennett.dev/blogs/raspberry-pi-hat-cam/"><meta property="og:image" content="https://jimbobbennett.dev/blogs/raspberry-pi-hat-cam/banner.png"><meta property="article:section" content="blogs"><meta property="article:published_time" content="2020-07-09T17:45:27+00:00"><meta property="article:modified_time" content="2020-07-09T17:45:27+00:00"><meta property="og:site_name" content="JimBobBennett"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://jimbobbennett.dev/blogs/raspberry-pi-hat-cam/banner.png"><meta name=twitter:title content="Raspberry Pi cloud-connected Hat Cam"><meta name=twitter:description content="This project builds a wearable, cloud connected camera. This is useful in situations where you want a record of what the camera sees stored in the cloud as quickly as possible. Make sure you use this in compliance will all applicable laws and privacy considerations."><meta name=twitter:site content="@jimbobbennett"><meta name=twitter:creator content="@jimbobbennett"><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css integrity=sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3 crossorigin=anonymous><link rel=stylesheet href=/css/header.css media=all><link rel=stylesheet href=/css/footer.css media=all><link rel=stylesheet href=/css/theme.css media=all><link rel="shortcut icon" type=image/png href=/fav.png><link rel="shortcut icon" sizes=192x192 href=/fav.png><link rel=apple-touch-icon href=/fav.png><link rel=alternate type=application/rss+xml href=https://jimbobbennett.dev/index.xml title=JimBobBennett><script type=text/javascript>(function(e,t,n,s,o,i,a){e[n]=e[n]||function(){(e[n].q=e[n].q||[]).push(arguments)},i=t.createElement(s),i.async=1,i.src="https://www.clarity.ms/tag/"+o,a=t.getElementsByTagName(s)[0],a.parentNode.insertBefore(i,a)})(window,document,"clarity","script","dctc2ydykv")</script><script data-goatcounter=https://jimbobbennett.goatcounter.com/count async src=//gc.zgo.at/count.js></script><style>:root{--text-color:#343a40;--text-secondary-color:#6c757d;--background-color:#000;--secondary-background-color:#64ffda1a;--primary-color:#007bff;--secondary-color:#f8f9fa;--text-color-dark:#e4e6eb;--text-secondary-color-dark:#b0b3b8;--background-color-dark:#000000;--secondary-background-color-dark:#212529;--primary-color-dark:#ffffff;--secondary-color-dark:#212529}body{background-color:#000;font-size:1rem;font-weight:400;line-height:1.5;text-align:left}</style><meta name=description content><link rel=stylesheet href=/css/index.css><link rel=stylesheet href=/css/single.css><link rel=stylesheet href=/css/projects.css media=all><script defer src=/fontawesome-5/all-5.15.4.js></script><title>Raspberry Pi cloud-connected Hat Cam | JimBobBennett</title></head><body class=light onload=loading()><header><nav class="pt-3 navbar navbar-expand-lg"><div class="container-fluid mx-xs-2 mx-sm-5 mx-md-5 mx-lg-5"><a class="navbar-brand primary-font text-wrap" href=/><img src=/fav.png width=30 height=30 class="d-inline-block align-top">
JimBobBennett
</a><button class=navbar-toggler type=button data-bs-toggle=collapse data-bs-target=#navbarContent aria-controls=navbarContent aria-expanded=false aria-label="Toggle navigation"><svg aria-hidden="true" height="24" viewBox="0 0 16 16" width="24" data-view-component="true"><path fill-rule="evenodd" d="M1 2.75A.75.75.0 011.75 2h12.5a.75.75.0 110 1.5H1.75A.75.75.0 011 2.75zm0 5A.75.75.0 011.75 7h12.5a.75.75.0 110 1.5H1.75A.75.75.0 011 7.75zM1.75 12a.75.75.0 100 1.5h12.5a.75.75.0 100-1.5H1.75z"/></svg></button><div class="collapse navbar-collapse text-wrap primary-font" id=navbarContent><ul class="navbar-nav ms-auto text-center"><li class="nav-item navbar-text"><a class=nav-link href=/ aria-label=home>Home</a></li><li class="nav-item navbar-text"><a class=nav-link href=/#about aria-label=about>About</a></li><li class="nav-item navbar-text"><a class=nav-link href=/#projects aria-label=projects>Recent Highlights</a></li><li class="nav-item navbar-text"><a class=nav-link href=/blogs title="Blog posts">Blog</a></li><li class="nav-item navbar-text"><a class=nav-link href=/videos title=Videos>Videos</a></li><li class="nav-item navbar-text"><a class=nav-link href=/livestreams title=Livestreams>Livestreams</a></li><li class="nav-item navbar-text"><a class=nav-link href=/conferences title=Conferences>Conferences</a></li><li class="nav-item navbar-text"><a class=nav-link href=/resume title=Resume>Resume</a></li></ul></div></div></nav></header><div id=content><section id=projects><div class="container pt-5" id=list-page><div class="row justify-content-center px-3 px-md-5"><h1 class="text-left pb-2 content">Raspberry Pi cloud-connected Hat Cam</h1><div class="text-left content"><a href=https://linkedin.com/in/jimbobbennett>Jim Bennett
</a><small>|</small>
Jul 9, 2020</div></div></div></section><section id=single><div class=container><div class="row justify-content-center"><div class="col-sm-12 col-md-12 col-lg-9"><div class=pr-lg-4><article class="page-content p-2"><p><strong>Build a cloud-connected hat/clothing camera powered by a Raspberry Pi and Azure!</strong></p><p><img src=https://github.com/jimbobbennett/pi-hat-cam/raw/main/images/make-jim-in-hat-cam.png alt="Jim wearing a hat cam"></p><blockquote><p>This project builds a wearable, cloud connected camera. This is useful in situations where you want a record of what the camera sees stored in the cloud as quickly as possible. Make sure you use this in compliance will all applicable laws and privacy considerations.</p><p>This is video only, no audio. If you want to add audio, then I&rsquo;d love a PR to add, or wait till I get a chance to add it.</p></blockquote><p>This project requires a Raspberry Pi connected to a Raspberry Pi Camera and WiFi. It continuously records short videos from the camera (by default 10 seconds in length), and uploads these to Azure blob storage. The ideal setup it a Pi Zero W due to it&rsquo;s small size and low power requirements, tethered to a mobile phone or hotspot for internet access.</p><blockquote><p>This uses a cloud service to store the videos, and therefor may incur a cost. If you have a free trial account, you can get $200 for the first 30 days which should more than cover the cost. Check out the <a href="https://azure.microsoft.com/pricing/details/storage/blobs/?WT.mc_id=pihatcam-blog-jabenn">Blob storage pricing guide</a> for more information on the cost of the service used.</p></blockquote><p>This method allow resiliency - if WiFi connection is lost the upload will keep retrying. If the device is damaged then everything already uploaded will be secure. Files are stored on the SD card and only deleted after successfully being uploaded, so if there is no internet connection, files can be grabbed off the SD card.</p><p>This also allows audit trails - each short video is named with the current timestamp, and Blob storage stores the time the file was uploaded.</p><p>This project also includes a utility to download all the blobs and concatenate them into a single video file.</p><h2 id=whats-required>What&rsquo;s required</h2><p>To make this, you will need:</p><ul><li>A Raspberry Pi Zero W (must be the W with WiFi access)</li><li>A Raspberry Pi camera module and appropriate ribbon cable that is as long as possible. The V2 camera is the best as it is small with good quality. The HQ camera can be used but is bigger which makes it harder to mount on clothing.</li><li>An SD Card</li><li>A USB power pack and appropriate cable to power the Pi</li><li>A mobile phone to tether to</li><li>A hat or other piece of clothing</li><li>Sewing materials, duct tape, bits of cloth to help affix the camera and Pi to your clothes</li></ul><h2 id=set-up-the-application>Set up the application</h2><p>Before you can run the application, you need an Azure subscription and a storage account.</p><h3 id=set-up-your-azure-subscription>Set up your Azure Subscription</h3><ul><li><p>If you are a student aged 18 and up and have an email address from an academic institution, you can sign up for the free Azure for Students offer at <a href="https://azure.microsoft.com/free/students/?WT.mc_id=pihatcam-blog-jabenn">azure.microsoft.com/free/students</a> without a credit card. At the time of writing this gives you $100 of credit to use over 12 months, as well as free tiers of a number of services for that 12 months. At the end of the 12 months, if you are still a student you can renew and get another $100 in credit and 12 months of free services.</p></li><li><p>If you are not a student, you can sign up at <a href="https://azure.microsoft.com/free/?WT.mc_id=pihatcam-blog-jabenn">azure.microsoft.com/free</a>. You will need a credit card for verification purposes only, you will not be billed unless you decide to upgrade your account to a paid offering. At the time of writing the free account will give you US$200 of free credit to spend on what you like in the first 30 days, 12 months of free services, plus a load of services that have tiers that are always free.</p></li></ul><h3 id=set-up-the-storage-account>Set up the storage account</h3><p>An Azure storage account is a general purpose account to store data as files, queues, tables or blobs. In this app, each short video is stored as a blob in the storage account.</p><p>To create a storage account:</p><ol><li><p>Head to <a href=https://aka.ms/AA8xjmk>ms.portal.azure.com/#create/Microsoft.StorageAccount-ARM</a> to go straight to the create a new storage resource blade</p></li><li><p>Sign in with your Azure account if necessary</p></li><li><p>Select your Azure subscription</p></li><li><p>For the <em>Resource group</em>, select <strong>Create new</strong>. Name the resource group <code>hatcam</code> then select <strong>OK</strong></p><p><img src=https://github.com/jimbobbennett/pi-hat-cam/raw/main/images/portal-storage-new-resource-group.png alt="Creating a new resource group"></p></li><li><p>Name the storage account. This name has to be globally unique across all storage accounts in Azure - this is because this name becomes part of the URL that can be used to access it. Pick a name that makes sense to you with something unique like your name, the date, etc.</p><blockquote><p>This name can only contain lowercase numbers and letters</p></blockquote></li><li><p>For the location, select the one closest to where you will be using the camera.</p><blockquote><p>If you want to see the locations of the regions, check out the map in the <a href="https://azure.microsoft.com/global-infrastructure/regions/?WT.mc_id=pihatcam-blog-jabenn">Azure global infrastructure guide</a>.</p></blockquote></li><li><p>Leave the rest of the values as the defaults</p><p><img src=https://github.com/jimbobbennett/pi-hat-cam/raw/main/images/portal-storage-all-details.png alt="The create storage form filled in"></p></li><li><p>Select <strong>Review + create</strong></p></li><li><p>The storage account settings will be validated. Once done, select <strong>Create</strong>.</p></li></ol><p>The deployment will begin. You will be notified when it&rsquo;s complete.</p><h3 id=get-the-connection-string>Get the connection string</h3><p>To connect to the storage account, you will need a connection string. To get this:</p><ol><li><p>Open the storage account in the Azure portal. You can do this by selecting <strong>Go to resource</strong> from the notification that pops up with the storage account is deployed.</p><p><img src=https://github.com/jimbobbennett/pi-hat-cam/raw/main/images/portal-storage-deployed-notification.png alt="The deployment notification"></p></li><li><p>From the side bar, select <strong>Settings -> Access keys</strong></p><p><img src=https://github.com/jimbobbennett/pi-hat-cam/raw/main/images/portal-storage-access-keys-menu.png alt="The access keys menu"></p></li><li><p>Select the <strong>Copy to clipboard</strong> button next to the <em>Connection string</em> under either <em>Key 1</em> or <em>Key 2</em>. It doesn&rsquo;t matter which one.</p><p><img src=https://github.com/jimbobbennett/pi-hat-cam/raw/main/images/portal-storage-access-keys.png alt="The connection string"></p></li><li><p>Store this connection string somewhere. You&rsquo;ll need it to configure your Pi code.</p></li></ol><h2 id=deploy-the-code>Deploy the code</h2><p>Once you have the storage account, it&rsquo;s time to deploy the code.</p><p>You can find the code in GitHub at <a href=https://github.com/jimbobbennett/pi-hat-cam>github.com/jimbobbennett/pi-hat-cam</a>.</p><p>The code is fully documented and commented, so check out the <a href=https://github.com/jimbobbennett/pi-hat-cam/blob/main/pi-app/app.py><code>app.py</code></a> file to see how it all works.</p><h3 id=configure-the-pi>Configure the Pi</h3><p>You will need to be running the latest Raspberry Pi OS on your Pi Zero W. To make the camera faster to launch, you should install Raspberry Pi OS Lite.</p><p>To do this, use the <a href=https://www.raspberrypi.org/blog/raspberry-pi-imager-imaging-utility/>Raspberry Pi imager</a>. When you choose the OS, select <strong>Raspberry Pi OS (other)</strong>, then select <strong>Raspberry Pi OS Lite (32 bit)</strong>.</p><p>Once your SD card is ready, configure the Pi for headless access by following the steps in this <a href=https://github.com/microsoft/rpi-resources/tree/master/headless-setup#setting-up-ssh-and-wifi>headless setup guide</a>. Work through the steps up to the <em>Remote desktop</em> section - you don&rsquo;t need to follow this section as it contains instructions when using the full Raspberry Pi OS, not the Lite version you are using here.</p><h3 id=deploy-the-python-code>Deploy the Python code</h3><p>The Python code you need is in this repo in the <code>pi-app</code> folder.</p><ol><li><p>SSH into your Pi</p></li><li><p>Install git, Pip and Python virtual environments using the following command:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>sudo apt install git
</span></span><span style=display:flex><span>sudo apt install python3-pip
</span></span><span style=display:flex><span>sudo apt install python3-venv
</span></span></code></pre></div></li><li><p>Clone the repo:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>git clone git@github.com:jimbobbennett/pi-hat-cam.git
</span></span></code></pre></div></li><li><p>Navigate to the folder containing the code</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>cd pi-hat-cam/pi-app
</span></span></code></pre></div></li><li><p>Create a <a href="https://docs.python.org/3/tutorial/venv.html#:~:text=%20Virtual%20Environments%20and%20Packages%20%C2%B6%20%201,upgrade%2C%20and%20remove%20packages%20using%20a...%20More%20">Python Virtual Environment</a>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>python3 -m venv .venv
</span></span></code></pre></div></li><li><p>Activate the virtual environment:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>source ./.venv/bin/activate
</span></span></code></pre></div></li><li><p>Install the Pip packages</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>pip install -r requirements.txt
</span></span></code></pre></div></li></ol><h3 id=configure-the-app>Configure the app</h3><p>Once the code is deployed, you&rsquo;ll need to configure the app to connect to your Azure storage account.</p><p>The code uses the <code>dotenv</code> package to read environment variables from a <code>.env</code> file. You will need to create this file and add the Azure storage connection string that you copied earlier to it.</p><ol><li><p>Create the file and open it for editing in <code>nano</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>nano .env
</span></span></code></pre></div></li><li><p>Add the following entry:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>BLOB_CONNECTION_STRING<span style=color:#f92672>=</span>&lt;connection_string&gt;
</span></span></code></pre></div><p>Replace <code>&lt;connection_string></code> with the connection string you copied earlier.</p></li><li><p>Close the file by pressing <em>ctrl+X</em>. You will be prompted to save the file, so select <code>yes</code> and press enter to select the <code>.env</code> filename.</p></li></ol><blockquote><p>There are other optional parameters you can add to this file to configure things like the video resolution or quality. Check out the <code>app.py</code> code for more details.</p></blockquote><h3 id=test-the-app>Test the app</h3><p>Before you use this in the wild, you should test the app.</p><ol><li><p>Connect the camera to the Pi</p></li><li><p>Run the Pi code with this command:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>python app.py
</span></span></code></pre></div></li><li><p>The app will start up and begin recording, uploading videos to blob storage once they are recorded. You should see something like this in the output:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span><span style=color:#f92672>(</span>.venv<span style=color:#f92672>)</span> pi@hat-cam:~/pi-hat-cam $ python app.py
</span></span><span style=display:flex><span>Checking container videos
</span></span><span style=display:flex><span>Setting camera resolution to <span style=color:#ae81ff>1280</span> , <span style=color:#ae81ff>720</span>
</span></span><span style=display:flex><span>Starting queue worker
</span></span><span style=display:flex><span>Recording ./videos/2020-07-08 07:42:51.h264
</span></span><span style=display:flex><span>Queuing ./videos/2020-07-08 07:42:51.h264
</span></span><span style=display:flex><span>Recording ./videos/2020-07-08 07:43:01.h264
</span></span><span style=display:flex><span>Uploading ./videos/2020-07-08 07:42:51.h264 to 2020-07-08 07:42:51.h264
</span></span><span style=display:flex><span>Deleting ./videos/2020-07-08 07:42:51.h264
</span></span></code></pre></div></li><li><p>Stop the app using <em>ctrl+c</em></p></li><li><p>Head to the storage account in the Azure portal.</p></li><li><p>Select <strong>Storage Explorer</strong> from the side menu</p><p><img src=https://github.com/jimbobbennett/pi-hat-cam/raw/main/images/portal-storage-storage-explorer.png alt="The storage explorer menu"></p></li><li><p>You should see the blob files that were uploaded listed here</p><p><img src=https://github.com/jimbobbennett/pi-hat-cam/raw/main/images/portal-storage-storage-explorer-files.png alt="The files listed in the storage explorer"></p></li></ol><p>You can download these files by selecting one and selecting <strong>Download</strong>. The downloaded file can be opened in an app like <a href=https://www.videolan.org/vlc/index.html>VLC</a>.</p><h3 id=configure-the-app-to-run-on-startup>Configure the app to run on startup</h3><p>Once the app is deployed, it can be run manually from the command line. It&rsquo;s better, however, if it is started when the Pi is booted - that way it is running automatically not long after the Pi is connected to power.</p><p>You can do this by adding an entry to the crontab. Cron is a tool that runs code at certain times, and can be configured to run the Pi code when the Pi is rebooted.</p><ol><li><p>Run the following code to configure the CronTab:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>sudo crontab -l &gt; cron.tmp
</span></span><span style=display:flex><span>echo <span style=color:#e6db74>&#34;@reboot sleep 30 &amp;&amp; cd /home/pi/pi-hat-cam/pi-app &amp;&amp; /home/pi/pi-hat-cam/pi-app/.venv/bin/python /home/pi/pi-hat-cam/pi-app/app.py&#34;</span> &gt;&gt; cron.tmp
</span></span><span style=display:flex><span>sudo crontab cron.tmp
</span></span><span style=display:flex><span>rm cron.tmp
</span></span></code></pre></div></li></ol><p>This code writes a new entry that is run on reboot. First it sleeps for 30 seconds to ensure the Pi is fully running and connected to the internet, then it launches the <code>app.py</code> file using the Python binary in the virtual environment.</p><p>Test this out by rebooting the Pi. You should see video files appear in the Storage Explorer in the Azure portal. Power the Pi off when done.</p><h2 id=download-the-video>Download the video</h2><p>By creating short videos it helps ensure the videos are uploaded, but this is not the best for watching later. It would be easier if there was a way to reassemble the video. The <code>video_downloader.py</code> file in the <code>downloader</code> folder has code to do this.</p><p>This file needs a <code>.env</code> file set up the same as the main app, with the <code>BLOB_CONNECTION_STRING</code> value set. There are other values you can configure from the default, and this are listed in the code.</p><p>Ideally you should run this code on a device that is not the Pi, so that you can view the video. You will need Python installed.</p><ol><li><p>From the folder the <code>video_downloader.py</code> is in, create a <a href="https://docs.python.org/3/tutorial/venv.html#:~:text=%20Virtual%20Environments%20and%20Packages%20%C2%B6%20%201,upgrade%2C%20and%20remove%20packages%20using%20a...%20More%20">Python Virtual Environment</a>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>python3 -m venv .venv
</span></span></code></pre></div><p>On Windows, use:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cmd data-lang=cmd><span style=display:flex><span>python -m venv .venv
</span></span></code></pre></div></li><li><p>Activate the virtual environment:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>source ./.venv/bin/activate
</span></span></code></pre></div></li><li><p>Install the Pip packages</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>pip install -r requirements.txt
</span></span></code></pre></div></li><li><p>Create a file called <code>.env</code> in your favorite text editor, such as <a href="https://code.visualstudio.com?WT.mc_id=pihatcam-blog-jabenn">Visual Studio Code</a></p></li><li><p>Add the following entry:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>BLOB_CONNECTION_STRING<span style=color:#f92672>=</span>&lt;connection_string&gt;
</span></span></code></pre></div><p>Replace <code>&lt;connection_string></code> with the connection string you copied earlier.</p></li><li><p>Run the code:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>python video_downloader<span style=color:#f92672>.</span>py
</span></span></code></pre></div></li></ol><p>This will download all the blobs, concatenating them into a single file called <code>downloaded_video.h264</code>. You can then view ths file in an app like <a href=https://www.videolan.org/vlc/index.html>VLC</a>.</p><blockquote><p>The blobs are not deleted when you download them. You will need to manually delete them from the storage resource once you are finished with them.</p></blockquote><h2 id=create-the-wearable>Create the wearable</h2><p>There&rsquo;s so many different pieces of clothing you could attach this to. In this guide I&rsquo;m going to focus on a cap.</p><p>You will need:</p><ul><li>A cap that you don&rsquo;t mind making holes in</li><li>Scissors</li><li>Gaffer tape, or offcuts of fabric and needle and thread depending on how good you are at sewing (I&rsquo;m not very good)</li><li>Double sided mounting tape</li><li>A USB power pack and USB cable that can reach from the pack in a pocket or strapped to a belt to the hat</li></ul><p><img src=https://github.com/jimbobbennett/pi-hat-cam/raw/main/images/make-all-parts.png alt="All the parts - cap, gaffer tape, scissors, pi, camera"></p><h3 id=mount-the-camera>Mount the camera</h3><ol><li><p>Make a small hole in the front of the cap - big enough for the camera lens to fit through</p></li><li><p>Place the camera inside the hat and push the lens through the hole. It might be easier to detach the camera from the board to pass it through the hole.</p><p><img src=https://github.com/jimbobbennett/pi-hat-cam/raw/main/images/make-camera-through-hole.png alt="The camera poking through a hole"></p></li><li><p>Fix the camera in place on the front of the hat with double-sided mounting tape. You can use fabric glue, but be careful not to get any on the lens. This also reduces you ability to easily re-use the camera in a different make.</p></li><li><p>Fix the camera circuit board in place inside the cap using gaffer tape</p><p><img src=https://github.com/jimbobbennett/pi-hat-cam/raw/main/images/camera-mounted-in-hat.png alt="The camera module in the hat"><img src=https://github.com/jimbobbennett/pi-hat-cam/raw/main/images/camera-taped-in-hat.png alt="The camera module taped in teh hat"></p></li><li><p>Fix the camera ribbon cable to the inside of the cap, right through to the hole at the back. Use gaffer tape or sew it in place.</p><p><img src=https://github.com/jimbobbennett/pi-hat-cam/raw/main/images/cable-taped-in-hat.png alt="Ribbon cable taped into the hat"></p></li><li><p>Mount the Raspberry Pi Zero W to the back of the cap, attaching the camera ribbon cable. Use double sided mounting tape, gaffer tape or sew it in place, whatever works. The USB sockets should point downwards.</p><p><img src=https://github.com/jimbobbennett/pi-hat-cam/raw/main/images/make-pi-fixed-to-hat.png alt="The pi mounted to a hat"></p></li><li><p>Test out the connections - power the Pi over USB and make sure videos are being uploaded. Also test out the fit and camera position, adjust it as necessary using tape or fabric.</p></li></ol><p><img src=https://github.com/jimbobbennett/pi-hat-cam/raw/main/images/make-jim-in-hat-cam.png alt="Jim in the hat cam"></p><h2 id=use-the-camera>Use the camera</h2><p>To use the camera, first it needs to be tethered to your phone or a WiFi hotspot to upload the videos. To tether:</p><ol><li><p>Connect to the Pi over SSH</p></li><li><p>Start your WiFi hotspot, or enable tethering on your phone</p></li><li><p>From your Pi, launch the configuration tool:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>sudo raspi-config
</span></span></code></pre></div></li><li><p>Select <strong>2 Network options</strong></p><p><img src=https://github.com/jimbobbennett/pi-hat-cam/raw/main/images/pi-config-main-menu.png alt="The pi config main menu"></p></li><li><p>Select <strong>N2 Wireless LAN</strong></p><p><img src=https://github.com/jimbobbennett/pi-hat-cam/raw/main/images/pi-config-network-menu.png alt="The network menu"></p></li><li><p>Enter the SSID and Password of your hotspot</p></li><li><p>Select <strong>Finish</strong></p></li><li><p>When asked to reboot, select <strong>Yes</strong></p></li></ol><p>When the Pi reboots, it will connect to your hotspot or phone.</p><p>Power off the camera until you are ready to use it.</p><p>Once you are ready to use it, connect the power and it will start recording as soon as it has booted up.</p><p>Here&rsquo;s the camera in action browsing this repo:</p><p><img src=https://github.com/jimbobbennett/pi-hat-cam/raw/main/images/cam-video.gif alt="A video of this repo being browsed on a computer"></p></article></div></div><div class="col-sm-12 col-md-12 col-lg-3"><div class=sticky-sidebar><aside class=toc><h5>Table Of Contents</h5><div class=toc-content><nav id=TableOfContents><ul><li><a href=#whats-required>What&rsquo;s required</a></li><li><a href=#set-up-the-application>Set up the application</a><ul><li><a href=#set-up-your-azure-subscription>Set up your Azure Subscription</a></li><li><a href=#set-up-the-storage-account>Set up the storage account</a></li><li><a href=#get-the-connection-string>Get the connection string</a></li></ul></li><li><a href=#deploy-the-code>Deploy the code</a><ul><li><a href=#configure-the-pi>Configure the Pi</a></li><li><a href=#deploy-the-python-code>Deploy the Python code</a></li><li><a href=#configure-the-app>Configure the app</a></li><li><a href=#test-the-app>Test the app</a></li><li><a href=#configure-the-app-to-run-on-startup>Configure the app to run on startup</a></li></ul></li><li><a href=#download-the-video>Download the video</a></li><li><a href=#create-the-wearable>Create the wearable</a><ul><li><a href=#mount-the-camera>Mount the camera</a></li></ul></li><li><a href=#use-the-camera>Use the camera</a></li></ul></nav></div></aside><aside class=tags><h5>Tags</h5><ul class="tags-ul list-unstyled list-inline"><li class=list-inline-item><a href=https://jimbobbennett.dev/tags/technology target=_blank>technology</a></li><li class=list-inline-item><a href=https://jimbobbennett.dev/tags/iot target=_blank>IoT</a></li><li class=list-inline-item><a href=https://jimbobbennett.dev/tags/azure target=_blank>azure</a></li><li class=list-inline-item><a href=https://jimbobbennett.dev/tags/maker target=_blank>maker</a></li></ul></aside></div></div></div><div class=row><div class="col-sm-12 col-md-12 col-lg-9 p-4"><div id=disqus_thread></div><script>var disqus_config=function(){this.page.url="https://jimbobbennett.dev/blogs/raspberry-pi-hat-cam/",this.page.identifier="8513869e4745e427d2c52eac8f8883c5"};(function(){if(window.location.hostname=="localhost")return;var e=document,t=e.createElement("script");t.src="https://jimbobbennett.disqus.com/embed.js",t.setAttribute("data-timestamp",+new Date),(e.head||e.body).appendChild(t)})()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript></div></div></div><button class="p-2 px-3" onclick=topFunction() id=topScroll>
<i class="fas fa-angle-up"></i></button></section><script>var topScroll=document.getElementById("topScroll");window.onscroll=function(){scrollFunction()};function scrollFunction(){document.body.scrollTop>20||document.documentElement.scrollTop>20?topScroll.style.display="block":topScroll.style.display="none"}function topFunction(){document.body.scrollTop=0,document.documentElement.scrollTop=0}</script></div><footer><div class="container py-4"><div class="row justify-content-center"><div class="col-md-4 text-center">&copy; 2023 All Rights Reserved</div></div></div></div></footer><script src=https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.min.js integrity=sha384-QJHtvGhmr9XOIpI6YVutG+2QOK9T+ZnN4kzFN1RtK3zEFEIsxhlmWl5/YESvpZ13 crossorigin=anonymous></script><script>document.body.className.includes("light")&&(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))</script><script>let loadingIcons;function loading(){myVar=setTimeout(showPage,100)}function showPage(){try{document.getElementById("loading-icons").style.display="block"}catch{}}</script><script>function createCopyButton(e,t){const n=document.createElement("button");n.className="copy-code-button",n.type="button",n.innerText="Copy",n.addEventListener("click",()=>copyCodeToClipboard(n,e,t)),addCopyButtonToDom(n,e)}async function copyCodeToClipboard(e,t,n){const s=t.querySelector("pre > code").innerText;try{n.writeText(s)}finally{codeWasCopied(e)}}function codeWasCopied(e){e.blur(),e.innerText="Copied!",setTimeout(function(){e.innerText="Copy"},2e3)}function addCopyButtonToDom(e,t){t.insertBefore(e,t.firstChild);const n=document.createElement("div");n.className="highlight-wrapper",t.parentNode.insertBefore(n,t),n.appendChild(t)}if(navigator&&navigator.clipboard)document.querySelectorAll(".highlight").forEach(e=>createCopyButton(e,navigator.clipboard));else{var script=document.createElement("script");script.src="https://cdnjs.cloudflare.com/ajax/libs/clipboard-polyfill/2.7.0/clipboard-polyfill.promise.js",script.integrity="sha256-waClS2re9NUbXRsryKoof+F9qc1gjjIhc2eT7ZbIv94=",script.crossOrigin="anonymous",script.onload=function(){addCopyButtons(clipboard)},document.querySelectorAll(".highlight").forEach(e=>createCopyButton(e,script)),document.body.appendChild(script)}</script></body></html>