<!doctype html><html><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=X-UA-Compatible content="ie=edge"><link rel=icon href=/fav.png type=image/png><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=preload as=style href="https://fonts.googleapis.com/css2?family=Alata&family=Lora&family=Muli:ital,wght@0,400;0,500;0,600;0,700;1,400;1,500;1,600;1,700&family=Roboto&family=Muli:ital,wght@0,100;0,300;0,400;0,500;0,700;0,900;1,100;1,300;1,400;1,500;1,700;1,900&display=swap"><link rel=stylesheet href="https://fonts.googleapis.com/css2?family=Alata&family=Lora&family=Muli:ital,wght@0,400;0,500;0,600;0,700;1,400;1,500;1,600;1,700&family=Roboto&family=Muli:ital,wght@0,100;0,300;0,400;0,500;0,700;0,900;1,100;1,300;1,400;1,500;1,700;1,900&display=swap" media=print onload='this.media="all"'><noscript><link href="https://fonts.googleapis.com/css2?family=Alata&family=Lora&family=Muli:ital,wght@0,400;0,500;0,600;0,700;1,400;1,500;1,600;1,700&family=Roboto&family=Muli:ital,wght@0,100;0,300;0,400;0,500;0,700;0,900;1,100;1,300;1,400;1,500;1,700;1,900&display=swap" rel=stylesheet></noscript><link rel=stylesheet href=/css/font.css media=all><meta property="og:title" content="Prototyping your first cloud-connected IoT project using an MXChip board and Azure IoT hub."><meta property="og:description" content="Learn how to build an internet connected fan using the MXChip Azure IoT dev kit and Azure IoT Hub"><meta property="og:type" content="article"><meta property="og:url" content="https://jimbobbennett.dev/blogs/internet-connected-fan/"><meta property="og:image" content="https://jimbobbennett.dev/blogs/internet-connected-fan/banner.png"><meta property="article:section" content="blogs"><meta property="article:published_time" content="2019-02-06T03:59:43+00:00"><meta property="article:modified_time" content="2019-02-06T03:59:43+00:00"><meta property="og:site_name" content="JimBobBennett"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://jimbobbennett.dev/blogs/internet-connected-fan/banner.png"><meta name=twitter:title content="Prototyping your first cloud-connected IoT project using an MXChip board and Azure IoT hub."><meta name=twitter:description content="Learn how to build an internet connected fan using the MXChip Azure IoT dev kit and Azure IoT Hub"><meta name=twitter:site content="@jimbobbennett"><meta name=twitter:creator content="@jimbobbennett"><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css integrity=sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3 crossorigin=anonymous><link rel=stylesheet href=/css/header.css media=all><link rel=stylesheet href=/css/footer.css media=all><link rel=stylesheet href=/css/theme.css media=all><link rel="shortcut icon" type=image/png href=/fav.png><link rel="shortcut icon" sizes=192x192 href=/fav.png><link rel=apple-touch-icon href=/fav.png><link rel=alternate type=application/rss+xml href=https://jimbobbennett.dev/index.xml title=JimBobBennett><script type=text/javascript>(function(e,t,n,s,o,i,a){e[n]=e[n]||function(){(e[n].q=e[n].q||[]).push(arguments)},i=t.createElement(s),i.async=1,i.src="https://www.clarity.ms/tag/"+o,a=t.getElementsByTagName(s)[0],a.parentNode.insertBefore(i,a)})(window,document,"clarity","script","dctc2ydykv")</script><script data-goatcounter=https://jimbobbennett.goatcounter.com/count async src=//gc.zgo.at/count.js></script><style>:root{--text-color:#343a40;--text-secondary-color:#6c757d;--background-color:#000;--secondary-background-color:#64ffda1a;--primary-color:#007bff;--secondary-color:#f8f9fa;--text-color-dark:#e4e6eb;--text-secondary-color-dark:#b0b3b8;--background-color-dark:#000000;--secondary-background-color-dark:#212529;--primary-color-dark:#ffffff;--secondary-color-dark:#212529}body{background-color:#000;font-size:1rem;font-weight:400;line-height:1.5;text-align:left}</style><meta name=description content><link rel=stylesheet href=/css/index.css><link rel=stylesheet href=/css/single.css><link rel=stylesheet href=/css/projects.css media=all><script defer src=/fontawesome-5/all-5.15.4.js></script><title>Prototyping your first cloud-connected IoT project using an MXChip board and Azure IoT hub. | JimBobBennett</title></head><body class=light onload=loading()><header><nav class="pt-3 navbar navbar-expand-lg"><div class="container-fluid mx-xs-2 mx-sm-5 mx-md-5 mx-lg-5"><a class="navbar-brand primary-font text-wrap" href=/><img src=/fav.png width=30 height=30 class="d-inline-block align-top">
JimBobBennett
</a><button class=navbar-toggler type=button data-bs-toggle=collapse data-bs-target=#navbarContent aria-controls=navbarContent aria-expanded=false aria-label="Toggle navigation"><svg aria-hidden="true" height="24" viewBox="0 0 16 16" width="24" data-view-component="true"><path fill-rule="evenodd" d="M1 2.75A.75.75.0 011.75 2h12.5a.75.75.0 110 1.5H1.75A.75.75.0 011 2.75zm0 5A.75.75.0 011.75 7h12.5a.75.75.0 110 1.5H1.75A.75.75.0 011 7.75zM1.75 12a.75.75.0 100 1.5h12.5a.75.75.0 100-1.5H1.75z"/></svg></button><div class="collapse navbar-collapse text-wrap primary-font" id=navbarContent><ul class="navbar-nav ms-auto text-center"><li class="nav-item navbar-text"><a class=nav-link href=/ aria-label=home>Home</a></li><li class="nav-item navbar-text"><a class=nav-link href=/#about aria-label=about>About</a></li><li class="nav-item navbar-text"><a class=nav-link href=/#projects aria-label=projects>Recent Highlights</a></li><li class="nav-item navbar-text"><a class=nav-link href=/blogs title="Blog posts">Blog</a></li><li class="nav-item navbar-text"><a class=nav-link href=/videos title=Videos>Videos</a></li><li class="nav-item navbar-text"><a class=nav-link href=/livestreams title=Livestreams>Livestreams</a></li><li class="nav-item navbar-text"><a class=nav-link href=/conferences title=Conferences>Conferences</a></li><li class="nav-item navbar-text"><a class=nav-link href=/resume title=Resume>Resume</a></li></ul></div></div></nav></header><div id=content><section id=projects><div class="container pt-5" id=list-page><div class="row justify-content-center px-3 px-md-5"><h1 class="text-left pb-2 content">Prototyping your first cloud-connected IoT project using an MXChip board and Azure IoT hub.</h1><div class="text-left content"><a href=https://linkedin.com/in/jimbobbennett>Jim Bennett
</a><small>|</small>
Feb 6, 2019</div></div></div></section><section id=single><div class=container><div class="row justify-content-center"><div class="col-sm-12 col-md-12 col-lg-9"><div class=pr-lg-4><article class="page-content p-2"><p>We all have cloud-connected devices. These are devices that do something taking advantage of sensors and hardware, then sync information via the cloud, such as sending sensor data or downloading configuration. For example, you might have a internet controlled thermostat in your home, that controls your heating and air conditioning, reports the temperature to the cloud so you can view it on your mobile device, and allows you to configure the temperature from your mobile device.</p><p>I decided to prototype my own cloud-connected IoT device by building an internet powered fan - a fan that comes on/goes off at a temperature threshold, reports the current temperature to the cloud, and allows you to control the on/off threshold also via the cloud. All this controlled by a mobile app.</p><p>You can find this project in GitHub here: <a href=https://github.com/jimbobbennett/InternetConnectedFan>https://github.com/jimbobbennett/InternetConnectedFan</a></p><p>This project contains all the code needed to build an internet connected fan using the <a href=https://microsoft.github.io/azure-iot-developer-kit/v1/>MXChip Azure IoT Dev Kit</a> and <a href="https://azure.microsoft.com/services/iot-hub/?WT.mc_id=iotfan-github-jabenn">Azure IoT Hub</a>.</p><p>This project detects the current temperature using the MSChips on-board temperature sensor, and if it is above a threshold, it will turn the fan on. It will also send telemetry data with the current temperature to an Azure IoT hub, which in turn triggers an Azure Function to save the temperature into a CosmosDB instance.</p><p>This project has a Xamarin mobile app that will poll another Azure Function to get the temperature and show it on screen. It also shows the threshold for turning on the fan, and this threshold can be configured from the app. Setting the value will call another Azure Function that updates the <a href="https://docs.microsoft.com/azure/iot-hub/iot-hub-devguide-device-twins/?WT.mc_id=iotfan-github-jabenn">device twin</a> for the device - a JSON document that is kept in sync between the device and the IoT hub. When the value on the hub is updated, it syncs to the device and the temperature threshold is updated, starting the fan if necessary.</p><h2 id=hardware>Hardware</h2><figure><img src=https://github.com/jimbobbennett/InternetConnectedFan/raw/master/Images/PhotoOfFinalHardware.jpg></figure><p>The hardware for this project is based around the MXChip which you can buy from <a href=https://amzn.to/2Bguvem>here</a> for around Â£40. This is an Arduino-compatible prototyping board that comes with a range of sensors, LEDs, buttons, a screen and other capabilities, as well as connectivity to Azure IoT Hub built in.</p><p>This then needs to be attached to a relay and a fan. For the fan, I used a simple battery powered fan that works with 2 AA batteries that is available <a href=https://amzn.to/2CYVQlm>here</a>. I removed the batteries and connected wires instead, removing the on/off switch and running the cables through the hole. The fan runs on 3V so I was able to use power from the MXChip instead of batteries, as this board can supply 3V.</p><p>The relay I used was one that came with an Intel Edison kit, but any 3V relay will do. To make wiring easier, I used the <a href=https://amzn.to/2BgtRxs>Inventors Kit for the BBC Micro:bit</a> - the MXChip has the same connector as the <a href=https://microbit.org/>Micro:bit</a>, and this kit converts the connector to a set of GPIO pins with a built in breadboard for easy prototyping.</p><p>Power to the relay poles was wired to the 3V/0V pins on the board, with PIN0 wired to the relay control. The input to the contacts was wired to 3V from the board, with the output connected to the +ve input on the fan. Finally the -ve input on the fan was wired to the 0V connection on the board.</p><figure><img src=https://github.com/jimbobbennett/InternetConnectedFan/raw/master/Images/Wiring.png></figure><h2 id=software>Software</h2><p>The software for this is in 3 parts - firmware for the device, some Azure Functions to work with device data and configure the device, and client code in the form of a mobile app.</p><h3 id=pre-requisites>Pre-requisites</h3><p>To build and deploy the firmware and Azure Function app you will need:</p><ul><li>A valid Azure account. Sign up for free <a href="https://azure.com/free/?WT.mc_id=iotfan-github-jabenn">here</a> if you don&rsquo;t already have an account.</li><li><a href="https://code.visualstudio.com/?WT.mc_id=iotfan-github-jabenn">VSCode</a></li><li>The VSCode <a href=https://github.com/Microsoft/vscode-iot-workbench>IoT Workbench extension</a>. This can be installed from inside VSCode.</li></ul><p>To build and deploy the mobile app, you will need:</p><ul><li><a href="https://visualstudio.microsoft.com/?WT.mc_id=iotfan-github-jabenn">Visual Studio</a>. This can be either Visual Studio 2017/2019 on Windows with the Xamarin workload installed, or Visual Studio for Mac.</li><li>To deploy on iOS you will need an <a href=https://developer.apple.com/>Apple Developer Account</a>.</li><li>To deploy to an Android device, you will need an Android device configured for <a href="https://docs.microsoft.com/xamarin/android/deploy-test/debugging/debug-on-device?WT.mc_id=iotfan-github-jabenn">developer mode</a>.</li></ul><h3 id=setting-up-the-development-environment>Setting up the development environment</h3><p>Start by opening the <code>project.code-workspace</code> file in VSCode.</p><p>Once you have the hardware assembled, you will need to configure the MXChip with a WiFi connection, create an Azure IoT hub and register the device. To do this, follow the instructions in the <a href=https://microsoft.github.io/azure-iot-developer-kit/docs/get-started/>Getting Started Guide</a> up to the <strong>Test the project</strong>section.</p><p>At this point, you will have an IoT hub configured, the device will be registered and and be configured with a connection string, and the code will be deployed to the device.</p><h3 id=firmware>Firmware</h3><p>The device code is in the <code>Device</code> folder in the project, and contains a single file called <code>FanController.ino</code>. This is an Arduino sketch file - a <strong>C</strong> file with the code for the firmware.</p><p>Arduino code has 2 functions called automatically - <code>setup</code> and <code>loop</code>.The <code>setup</code> function is called once when the device starts up, and is a good place to initialize the device, connect to WiFi etc. After that, the <code>loop</code> function is called repeatedly to do whatever your code needs.</p><p>The <code>setup</code> function for this project initializes the WiFi, connects to the IoT hub over MQTT including setting up a callback for updates to the device twin, then initializes one of the pins, <strong>PIN0</strong>, to send data. This pin is used to control the relay.</p><p>The <code>loop</code> function polls the sensor for the current temperature, writing it to the screen and sending it as a message to the IoT hub over MQTT.</p><ul><li>If the temperature is above the threshold, a signal is sent to <strong>PIN0</strong> to turn on the relay and send power to the fan, starting it up. The on-board LED is also turned to red.</li><li>If the temperature is below the threshold, the signal is stopped, turning the relay off and stopping power to the fan. The LED is set to blue. At the end of the function, it sleeps for 5 seconds to give a delay between polls of the sensor.</li></ul><p>The device twin callback function, <code>DeviceTwinCallback</code>, is called whenever an update to the device twin is received by the board. This callback parses the JSON that is sent, extracting the threshold value.</p><p>When you worked through the setup, you would have deployed the code to the device, so this should be running already. If you want to re-deploy, use the <em>Azure IoT Device Workbench: Upload Device Code</em> option from the Command Palette.</p><p>When this app is running, you will be able to see telemetry on the messages received by navigating to your IoT hub in the <a href="https://portal.azure.com/?WT.mc_id=iotfan-github-jabenn">Azure Portal</a>.</p><figure><img src=https://github.com/jimbobbennett/InternetConnectedFan/raw/master/Images/Telemetry.png></figure><h3 id=azure-function-app>Azure Function App</h3><p>The Azure Function app lives in the <code>Functions</code> folder, and has 3 functions:</p><ul><li>An event hub trigger that is called whenever a message is received by the IoT hub from the device. This saves the temperature to a CosmosDB instance.</li><li>A function to retrieve the temperature from CosmosDB</li><li>A function to update the temperature threshold using a device twin</li></ul><p>This function app is written in C#, using Azunre Functions V2.</p><p>For the sake of simplicity, this app assumes you only have one device and the device id is <code>fan-controller</code>.</p><p>Before you can wire up the function app, you will need to create a CosmosDB instance using your preferred method (for example the <a href="https://portal.azure.com/?WT.mc_id=iotfan-github-jabenn">Azure Portal</a>). Ideally this should be in the same resource group as the IoT hub for easier resource management, such as deleting all the resources when you are done. Once this has been created, create a database called <code>Devices</code> containing a collection called <code>Temperatures</code>. Take a copy of one of the connection strings from the <em>Read-write Keys</em> tab of the <em>Keys</em> section as you will need this later.</p><p>To deploy the function app, use the Command Palette and select <em>Azure IoT Device Workbench: Deploy to Azure&mldr;</em>. Then select <em>Function App</em>. This will walk you through the steps to create a new function app in the same resource group as your IoT Hub, and deploy the code to it. Open the function app in the <a href="https://portal.azure.com/?WT.mc_id=iotfan-github-jabenn">portal</a>, and head to the <em>Application Settings</em> tab. Add 2 new settings:</p><ul><li><code>CosmosDBConnection</code> - set this to the CosmosDB connection string you copied earlier</li><li><code>ecs</code> - set this to be the <em>Event-hub compatible endpoint</em> value from the <em>Built-in endpoints</em> section of the IoT hub.</li></ul><p>After these settings have been updated, you should be able to use the storage explorer for the CosmosDB instance and see the temperature being written for the device. It will only write one record, overwriting it each time to save storage space.</p><p>You should now be able to retrieve the temperature and update the threshold using the REST endpoint, for example with a tool such as <a href=https://www.getpostman.com/downloads/>Postman</a>. Make a <code>GET</code> request to <code>https://&lt;your function app>/api/temperature/fan-controller</code> to get back a JSON document with the temperature for the <code>fan-controller</code> device.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;partitionKey&#34;</span> : <span style=color:#e6db74>&#34;temperature&#34;</span>,   
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;id&#34;</span> : <span style=color:#e6db74>&#34;fan-controller&#34;</span>,   
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;temperature&#34;</span> : <span style=color:#ae81ff>24.6</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>To update the threshold, send a <code>POST</code> to <code>https://&lt;your function app>/api/temp-threshold/fan-controller</code> with the following JSON body:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{   
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;threshold&#34;</span> : <span style=color:#960050;background-color:#1e0010>&lt;the_threshold&gt;</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>setting <code>&lt;the_threshold></code> to be a double value of the threshold you want. For example, to set the threshold to 20Â°C use:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{   
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;threshold&#34;</span> : <span style=color:#ae81ff>20.0</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=mobile-app>Mobile app</h3><p>To build the mobile app, open the <code>FanController.sln</code> file in Visual Studio. Set the Android or iOS app to be the startup app depending on what device you want to run on.</p><p>You will need to update the <code>urlRoot</code> field in the <code>FanController\MainViewModel.cs</code> file to be the function app URL root - so <code>&lt;your function app>.azurewebsites.net</code> without the <code>https://</code> part.</p><p>Launch the app and you will see the temperature. Use the slider to change the threshold and tap the <em>Set</em> button to set this threshold. Once you tap <em>Set</em> you should see the threshold on the device change and the fan come on or turn off if applicable.</p></article></div></div><div class="col-sm-12 col-md-12 col-lg-3"><div class=sticky-sidebar><aside class=toc><h5>Table Of Contents</h5><div class=toc-content><nav id=TableOfContents><ul><li><a href=#hardware>Hardware</a></li><li><a href=#software>Software</a><ul><li><a href=#pre-requisites>Pre-requisites</a></li><li><a href=#setting-up-the-development-environment>Setting up the development environment</a></li><li><a href=#firmware>Firmware</a></li><li><a href=#azure-function-app>Azure Function App</a></li><li><a href=#mobile-app>Mobile app</a></li></ul></li></ul></nav></div></aside><aside class=tags><h5>Tags</h5><ul class="tags-ul list-unstyled list-inline"><li class=list-inline-item><a href=https://jimbobbennett.dev/tags/technology target=_blank>technology</a></li><li class=list-inline-item><a href=https://jimbobbennett.dev/tags/iot target=_blank>IoT</a></li><li class=list-inline-item><a href=https://jimbobbennett.dev/tags/xamarin target=_blank>xamarin</a></li></ul></aside></div></div></div><div class=row><div class="col-sm-12 col-md-12 col-lg-9 p-4"><div id=disqus_thread></div><script>var disqus_config=function(){this.page.url="https://jimbobbennett.dev/blogs/internet-connected-fan/",this.page.identifier="f00cc9cedb11c83aaa975c3979ec8a1f"};(function(){if(window.location.hostname=="localhost")return;var e=document,t=e.createElement("script");t.src="https://jimbobbennett.disqus.com/embed.js",t.setAttribute("data-timestamp",+new Date),(e.head||e.body).appendChild(t)})()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript></div></div></div><button class="p-2 px-3" onclick=topFunction() id=topScroll>
<i class="fas fa-angle-up"></i></button></section><script>var topScroll=document.getElementById("topScroll");window.onscroll=function(){scrollFunction()};function scrollFunction(){document.body.scrollTop>20||document.documentElement.scrollTop>20?topScroll.style.display="block":topScroll.style.display="none"}function topFunction(){document.body.scrollTop=0,document.documentElement.scrollTop=0}</script></div><footer><div class="container py-4"><div class="row justify-content-center"><div class="col-md-4 text-center">&copy; 2024 All Rights Reserved</div></div></div></div></footer><script src=https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.min.js integrity=sha384-QJHtvGhmr9XOIpI6YVutG+2QOK9T+ZnN4kzFN1RtK3zEFEIsxhlmWl5/YESvpZ13 crossorigin=anonymous></script><script>document.body.className.includes("light")&&(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))</script><script>let loadingIcons;function loading(){myVar=setTimeout(showPage,100)}function showPage(){try{document.getElementById("loading-icons").style.display="block"}catch{}}</script><script>function createCopyButton(e,t){const n=document.createElement("button");n.className="copy-code-button",n.type="button",n.innerText="Copy",n.addEventListener("click",()=>copyCodeToClipboard(n,e,t)),addCopyButtonToDom(n,e)}async function copyCodeToClipboard(e,t,n){const s=t.querySelector("pre > code").innerText;try{n.writeText(s)}finally{codeWasCopied(e)}}function codeWasCopied(e){e.blur(),e.innerText="Copied!",setTimeout(function(){e.innerText="Copy"},2e3)}function addCopyButtonToDom(e,t){t.insertBefore(e,t.firstChild);const n=document.createElement("div");n.className="highlight-wrapper",t.parentNode.insertBefore(n,t),n.appendChild(t)}if(navigator&&navigator.clipboard)document.querySelectorAll(".highlight").forEach(e=>createCopyButton(e,navigator.clipboard));else{var script=document.createElement("script");script.src="https://cdnjs.cloudflare.com/ajax/libs/clipboard-polyfill/2.7.0/clipboard-polyfill.promise.js",script.integrity="sha256-waClS2re9NUbXRsryKoof+F9qc1gjjIhc2eT7ZbIv94=",script.crossOrigin="anonymous",script.onload=function(){addCopyButtons(clipboard)},document.querySelectorAll(".highlight").forEach(e=>createCopyButton(e,script)),document.body.appendChild(script)}</script></body></html>