<!doctype html><html><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=X-UA-Compatible content="ie=edge"><link rel=icon href=/fav.png type=image/png><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=preload as=style href="https://fonts.googleapis.com/css2?family=Alata&family=Lora&family=Muli:ital,wght@0,400;0,500;0,600;0,700;1,400;1,500;1,600;1,700&family=Roboto&family=Muli:ital,wght@0,100;0,300;0,400;0,500;0,700;0,900;1,100;1,300;1,400;1,500;1,700;1,900&display=swap"><link rel=stylesheet href="https://fonts.googleapis.com/css2?family=Alata&family=Lora&family=Muli:ital,wght@0,400;0,500;0,600;0,700;1,400;1,500;1,600;1,700&family=Roboto&family=Muli:ital,wght@0,100;0,300;0,400;0,500;0,700;0,900;1,100;1,300;1,400;1,500;1,700;1,900&display=swap" media=print onload='this.media="all"'><noscript><link href="https://fonts.googleapis.com/css2?family=Alata&family=Lora&family=Muli:ital,wght@0,400;0,500;0,600;0,700;1,400;1,500;1,600;1,700&family=Roboto&family=Muli:ital,wght@0,100;0,300;0,400;0,500;0,700;0,900;1,100;1,300;1,400;1,500;1,700;1,900&display=swap" rel=stylesheet></noscript><link rel=stylesheet href=/css/font.css media=all><meta property="og:title" content="Controlling an IoT device from your phone"><meta property="og:description" content="I&rsquo;ve just finished watching the latest episode of Five Things, where Suz Hinton talks with Burke about Goo Goo Clusters and IoT devices.
One of the devices Suz showed was the Azure IoT DevKit - an arduino compatible board made by MXChip that works beautifully with Azure, even down to having an Azure LED on board to show when it is connected. This is a great little board with a whole load of sensors and other gubbins built in."><meta property="og:type" content="article"><meta property="og:url" content="https://jimbobbennett.dev/blogs/controlling-an-iot-device-from-your-phone/"><meta property="og:image" content="https://jimbobbennett.dev/blogs/controlling-an-iot-device-from-your-phone/banner.png"><meta property="article:section" content="blogs"><meta property="article:published_time" content="2018-11-19T17:26:51+00:00"><meta property="article:modified_time" content="2018-11-19T17:26:51+00:00"><meta property="og:site_name" content="JimBobBennett"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://jimbobbennett.dev/blogs/controlling-an-iot-device-from-your-phone/banner.png"><meta name=twitter:title content="Controlling an IoT device from your phone"><meta name=twitter:description content="I&rsquo;ve just finished watching the latest episode of Five Things, where Suz Hinton talks with Burke about Goo Goo Clusters and IoT devices.
One of the devices Suz showed was the Azure IoT DevKit - an arduino compatible board made by MXChip that works beautifully with Azure, even down to having an Azure LED on board to show when it is connected. This is a great little board with a whole load of sensors and other gubbins built in."><meta name=twitter:site content="@jimbobbennett"><meta name=twitter:creator content="@jimbobbennett"><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css integrity=sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3 crossorigin=anonymous><link rel=stylesheet href=/css/header.css media=all><link rel=stylesheet href=/css/footer.css media=all><link rel=stylesheet href=/css/theme.css media=all><link rel="shortcut icon" type=image/png href=/fav.png><link rel="shortcut icon" sizes=192x192 href=/fav.png><link rel=apple-touch-icon href=/fav.png><link rel=alternate type=application/rss+xml href=https://jimbobbennett.dev/index.xml title=JimBobBennett><script type=text/javascript>(function(e,t,n,s,o,i,a){e[n]=e[n]||function(){(e[n].q=e[n].q||[]).push(arguments)},i=t.createElement(s),i.async=1,i.src="https://www.clarity.ms/tag/"+o,a=t.getElementsByTagName(s)[0],a.parentNode.insertBefore(i,a)})(window,document,"clarity","script","dctc2ydykv")</script><script data-goatcounter=https://jimbobbennett.goatcounter.com/count async src=//gc.zgo.at/count.js></script><style>:root{--text-color:#343a40;--text-secondary-color:#6c757d;--background-color:#000;--secondary-background-color:#64ffda1a;--primary-color:#007bff;--secondary-color:#f8f9fa;--text-color-dark:#e4e6eb;--text-secondary-color-dark:#b0b3b8;--background-color-dark:#000000;--secondary-background-color-dark:#212529;--primary-color-dark:#ffffff;--secondary-color-dark:#212529}body{background-color:#000;font-size:1rem;font-weight:400;line-height:1.5;text-align:left}</style><meta name=description content><link rel=stylesheet href=/css/index.css><link rel=stylesheet href=/css/single.css><link rel=stylesheet href=/css/projects.css media=all><script defer src=/fontawesome-5/all-5.15.4.js></script><title>Controlling an IoT device from your phone | JimBobBennett</title></head><body class=light onload=loading()><header><nav class="pt-3 navbar navbar-expand-lg"><div class="container-fluid mx-xs-2 mx-sm-5 mx-md-5 mx-lg-5"><a class="navbar-brand primary-font text-wrap" href=/><img src=/fav.png width=30 height=30 class="d-inline-block align-top">
JimBobBennett
</a><button class=navbar-toggler type=button data-bs-toggle=collapse data-bs-target=#navbarContent aria-controls=navbarContent aria-expanded=false aria-label="Toggle navigation"><svg aria-hidden="true" height="24" viewBox="0 0 16 16" width="24" data-view-component="true"><path fill-rule="evenodd" d="M1 2.75A.75.75.0 011.75 2h12.5a.75.75.0 110 1.5H1.75A.75.75.0 011 2.75zm0 5A.75.75.0 011.75 7h12.5a.75.75.0 110 1.5H1.75A.75.75.0 011 7.75zM1.75 12a.75.75.0 100 1.5h12.5a.75.75.0 100-1.5H1.75z"/></svg></button><div class="collapse navbar-collapse text-wrap primary-font" id=navbarContent><ul class="navbar-nav ms-auto text-center"><li class="nav-item navbar-text"><a class=nav-link href=/ aria-label=home>Home</a></li><li class="nav-item navbar-text"><a class=nav-link href=/#about aria-label=about>About</a></li><li class="nav-item navbar-text"><a class=nav-link href=/#projects aria-label=projects>Recent Highlights</a></li><li class="nav-item navbar-text"><a class=nav-link href=/blogs title="Blog posts">Blog</a></li><li class="nav-item navbar-text"><a class=nav-link href=/videos title=Videos>Videos</a></li><li class="nav-item navbar-text"><a class=nav-link href=/livestreams title=Livestreams>Livestreams</a></li><li class="nav-item navbar-text"><a class=nav-link href=/conferences title=Conferences>Conferences</a></li><li class="nav-item navbar-text"><a class=nav-link href=/resume title=Resume>Resume</a></li></ul></div></div></nav></header><div id=content><section id=projects><div class="container pt-5" id=list-page><div class="row justify-content-center px-3 px-md-5"><h1 class="text-left pb-2 content">Controlling an IoT device from your phone</h1><div class="text-left content"><a href=https://linkedin.com/in/jimbobbennett>Jim Bennett
</a><small>|</small>
Nov 19, 2018</div></div></div></section><section id=single><div class=container><div class="row justify-content-center"><div class="col-sm-12 col-md-12 col-lg-9"><div class=pr-lg-4><article class="page-content p-2"><p>I&rsquo;ve just finished watching the <a href="https://channel9.msdn.com/Shows/5-Things/Five-IoT-Devices-You-Should-Have-Bought-Yesterday/?WT.mc_id=mxchip-blog-jabenn">latest episode of Five Things</a>, where <a href=https://twitter.com/noopkat>Suz Hinton</a> talks with <a href=https://twitter.com/burkeholland>Burke</a> about <a href=https://googoo.com>Goo Goo Clusters</a> and IoT devices.</p><a href=https://googoo.com><div class=image-div style=max-width:400px><p><img src=goo-goo-cluster-logo.png alt="Goo Goo clusters logo"></p></div></a><p>One of the devices Suz showed was the <a href=https://microsoft.github.io/azure-iot-developer-kit/>Azure IoT DevKit</a> - an arduino compatible board made by <a href=http://mxchip.com/az3166>MXChip</a> that works beautifully with Azure, even down to having an Azure LED on board to show when it is connected. This is a great little board with a whole load of sensors and other gubbins built in.</p><div class=image-div style=max-width:400px><p><img src=IMG_3002-1.JPG alt="My MXChip board"></p></div><p>I have one of these boards thanks to Suz, so I thought it would be a good opportunity to get it out again and see how easy it would be to get my phone to control the board via Azure, with the eventual goal of doing some kind of holiday hack such as using it to control Christmas lights.</p><h3 id=getting-started-with-the-iot-devkit>Getting started with the IoT DevKit</h3><ul><li>Buy one! Lots of links here - <a href=http://mxchip.com/az3166>http://mxchip.com/az3166</a>. These boards are around $40 so not too expensive - maybe put one on your Christmas list.</li><li>Follow the first part of the <a href=https://github.com/Microsoft/vscode-iot-workbench/blob/master/docs/iot-devkit/devkit-get-started.md>Getting Started</a> guide to <a href=https://github.com/Microsoft/vscode-iot-workbench/blob/master/docs/iot-devkit/devkit-get-started.md#prepare-your-hardware>prepare your hardware</a>, <a href=https://github.com/Microsoft/vscode-iot-workbench/blob/master/docs/iot-devkit/devkit-get-started.md#configure-wi-fi>configure WiFi</a> and <a href=https://github.com/Microsoft/vscode-iot-workbench/blob/master/docs/iot-devkit/devkit-get-started.md#install-development-environment>install the development environment</a>.</li><li>Sign up for an Azure account. If you don&rsquo;t already have an Azure account, you will need to sign up for one. There is a free tier that at the time of writing gives US$200 for the first 30 days, loads of services for free for 12 months, and a range of services free forever. You can sign up <a href=https://aka.ms/FreeAz>for the free tier here</a>!</li></ul><p>Once done your board will be ready to program.</p><h3 id=controlling-the-board-from-the-cloud>Controlling the board from the cloud</h3><p>My plan is to build an app where I can set a color and have the LED on the board match that color. The architecture I want is something like this:</p><div class=image-div style=max-width:600px><p><img src=Sketch.png alt="Architecture of the app - a mobile device with RGB sliders talking to An Azure Functions back end via REST talking somehow to the IoT device"></p></div><p>Part of this is easy - a mobile app talking to an Azure Functions back end over a REST API. The new bit for me is the big <strong>?</strong>, the bit where the IoT device talks to the back end.</p><h4 id=azure-iot>Azure IoT</h4><p>Azure has some great services for managing IoT devices, all based around <a href="https://docs.microsoft.com/azure/iot-hub/?WT.mc_id=mxchip-blog-jabenn">IoT Hub</a>. IoT Hub is a managed service that provides a central resource for two-way communication with IoT devices. You can register devices in the hub, configure them individually or en-masse, send and receive data using standard messaging protocols like <a href=http://mqtt.org>MQTT</a>, or manage the devices including updating firmware.</p><p>One feature that it also supports is <a href="https://docs.microsoft.com/azure/iot-hub/iot-hub-devguide-device-twins/?WT.mc_id=mxchip-blog-jabenn">device twins</a>.</p><div class=image-div style=max-width:400px><p><img src=frank-mckenna-720261-unsplash.jpg alt="Stock photo of some twins"></p></div><p>Device twins are JSON documents that store information such as state or configuration. These exist on both the device and the Azure IoT hub and are kept in sync, so if you update a value on the device it syncs to the cloud and vice versa. This is perfect for my app - I can encode the RGB value for the LED into a device twin and update it from my Azure function. This update will then be pushed to the device where it can be parsed and the LED color changed to match.</p><blockquote><p>If you want to see this in action, then there is a great demo project available <a href=https://github.com/Microsoft/vscode-iot-workbench/blob/master/docs/iot-devkit/devkit-state.md>here</a> that creates a web site that can turn the LED on/off and set the color. It doesn&rsquo;t go into how it works, just shows you that it does so I thought it would be more fun to try to build it myself. The rest of this post covers how I did it instead of just following this walkthrough.</p></blockquote><h4 id=creating-an-iot-hub>Creating an IoT hub</h4><p>The first thing I needed to do was to create an IoT workbench project and set up the IoT hub and device. This can be done from inside VSCode using the <a href="https://marketplace.visualstudio.com/items?itemName=vsciot-vscode.vscode-iot-workbench&amp;WT.mc_id=mxchip-blog-jabenn">Azure IoT Workbench extension</a>. Launch VSCode, then plug in the IoT Dev Kit.</p><p>To create a new IoT workbench project:</p><ul><li>Launch the command palette and select <strong>IoT Workbench: New</strong>.</li><li>Give it a folder to create the project in</li><li>Give the project a name</li><li>Select the IoT DevKit device.</li><li>Create a project with an Azure IoT Hub</li><li>Use the default sketch file name (sketch files are C code files that are run on the IoT device)</li></ul><p>Once the project has been created, the IoT hub needs to be created and the device needs to be registered with the hub. Again, this can be done from inside VS Code.</p><ul><li>Launch the command palette and select <strong>IoT Workbench: Cloud</strong></li><li>Select <strong>Azure Provision</strong></li><li>Select a subscription, signing into Azure if necessary</li><li>Create a new resource group or select an existing one</li><li>Create a new IoT Hub in a location near you</li><li>Select the <em>F1</em> free tier. If you already have a free tier set up for another project then use an <em>S</em> tier - the <em>B</em> tiers don&rsquo;t support device twins, and the <em>F1</em> tier acts like an <em>S</em> tier but with limits on messages.</li><li>Give the IoT Hub a name - this will need to be globally unique across Azure.</li><li>The IoT Hub will now be provisioned, and this will take a few minutes to complete.</li></ul><p>Once the Hub has been provisioned, the device will need to be provisioned, and this step will start automatically once the Hub has been created.</p><ul><li>Create a new IoT device</li><li>Give the device a name. Each device will need to have a unique name in the IoT hub.</li></ul><p>Once done you will be able to navigate to your IoT Hub in the <a href="https://portal.azure.com/?WT.mc_id=mxchip-blog-jabenn">Azure Portal</a> and see your device.</p><div class=image-div style=max-width:400px><p><img src=2018-11-16_14-41-56.png alt="The IoT device shown in the IoT Hub in the Azure portal"></p></div><p>Finally the IoT device needs to know the connection string so that it can connect to the IoT Hub.</p><ul><li>Put the IoT device into configuration mode by holding the <strong>A</strong> button on the device, tapping the <strong>Reset</strong> button, then releasing the <strong>A</strong> button.</li></ul><div class=image-div style=max-width:400px><p><img src=IMG_9124.jpg alt="The A and reset buttons on the IoT device"></p></div><ul><li>From the command palette select <strong>IoT Workbench: Device</strong></li><li>Select <strong>Config Device Settings</strong></li><li>Select <strong>Config Device Connection String</strong></li><li>Select <strong>Select IoT Hub Device Connection String</strong></li></ul><p>A notification will pop up once done. The IoT device can then be rebooted by disconnecting and re-connecting it, and when it&rsquo;s booted it will be connected to the IoT Hub, as indicated by the blue Azure LED being lit.</p><div class=image-div style=max-width:400px><p><img src=IMG_5787.JPG alt="The Azure LED lit up"></p></div><h4 id=adding-code-to-handle-the-device-twin>Adding code to handle the device twin</h4><p>The device is configured, so now it needs some code to detect updates to the device twin and update the LED color.</p><p>The code for this is <a href=https://github.com/jimbobbennett/IoTLedColorChanger/blob/master/DevKit/Device/device.ino>here</a>. Copy this code into the sketch file in the IoT project (the <code>.ino</code> file). The interesting parts of this code are the <code>setup</code> and <code>loop</code> methods.</p><h6 id=the-setup-method>The setup method</h6><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>setup</span>()
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  ...
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>DevKitMQTTClient_Init</span>(true);
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>DevKitMQTTClient_SetDeviceTwinCallback</span>(DeviceTwinCallback);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>The <a href="https://www.arduino.cc/en/Reference/Setup?setlang=en"><code>setup</code> method</a> is a special method that is called every time the device starts up or is rest. This method is used to initialize things, such as the WiFi and connectivity to IoT Hub.</p><ul><li><p>The <code>DevKitMQTTClient_Init</code> call initializes the MQTT client to connect to Azure IoT Hub.</p></li><li><p>The call to <code>DevKitMQTTClient_SetDeviceTwinCallback</code> sets up a callback for any updates to the device twin on the IoT Hub. In the <code>DeviceTwinCallback</code> function, the JSON payload is parsed looking for one of these values:</p><ul><li><code>"rgbLEDR"</code> - The red value for the LED from 0 to 255</li><li><code>"rgbLEDG"</code> - The Green value for the LED from 0 to 255</li><li><code>"rgbLEDB"</code> - The Blue value for the LED from 0 to 255</li></ul><p>Once these values are found they are stored in global variables.</p></li></ul><h6 id=the-loop-method>The loop method</h6><p>The other method of interest is the <a href="https://www.arduino.cc/en/Reference/Loop?setlang=en"><code>loop</code> method</a>. This method is a special one that is called repeatedly by the OS on a loop. This method sets up the LED based on the on/off and RGB values stored in the global variables then applies these to the LED. It then sleeps for a bit and loops again.</p><h6 id=deploying-the-code>Deploying the code</h6><p>Once you&rsquo;ve added the code, it needs to be deployed to the device:</p><ul><li>Select <strong>IoT Workbench: Device</strong> from the command palette</li><li>Select <strong>Device Upload</strong></li></ul><p>The code will be compiled, uploaded to the device, and the device will reboot. After rebooting it will be ready to sync data using the device twin.</p><blockquote><p>Once the code has been deployed, the IoT device can be unplugged from your computer and connected to another power supply if needed. The connection to a computer is only needed for configuration and uploading code, when running it just needs power through the USB port, nothing else.</p></blockquote><h4 id=testing-out-the-device-twin>Testing out the device twin</h4><p>Once the device reboots, it will start listening to updates to the device twin. The device twin can be updated in code, but a simple way to get started is using the <a href="https://portal.azure.com/?WT.mc_id=mxchip-blog-jabenn">Azure portal</a>.</p><p>From inside the portal:</p><ul><li>Open up the newly created IoT hub</li><li>Select <em>Explorers->IoT devices</em></li><li>Select the IoT device from the list</li><li>Select <strong>Device twin</strong> from the menu across the top</li></ul><div class=image-div style=max-width:400px><p><img src=2018-11-19_12-25-50.png alt="The Device Twin menu item"></p></div><p>This will show the device twin JSON document in an editor. This document can be updated, and once the update is saved it will be sent to the device. To turn the LED on on the IoT device, values for <code>rgbLEDR</code>, <code>rgbLEDG</code> and <code>rgbLEDB</code> need to be added to the existing <em>properties->desired</em> node in the JSON document:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#960050;background-color:#1e0010>...</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;properties&#34;</span>: {
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;desired&#34;</span>: {
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;rgbLEDR&#34;</span>: <span style=color:#ae81ff>0</span>,
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;rgbLEDG&#34;</span>: <span style=color:#ae81ff>255</span>,
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;rgbLEDB&#34;</span>: <span style=color:#ae81ff>0</span>,
</span></span><span style=display:flex><span>  <span style=color:#960050;background-color:#1e0010>...</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Once these values are added and the document saved, the LED will light up in bright green. Then changing these values will cause the LED to change color.</p><div class=image-div style=max-width:400px><p><img src=IMG_9194-1.jpg alt="The LED lit up in green">
<img src=IMG_9195-1.jpg alt="The LED lit up in red"></p></div><h4 id=updating-the-device-twins-from-an-azure-function>Updating the device twins from an Azure function</h4><p>The device is working, so the next step is to create a back end that can be called from a mobile app to update the device twin. For this I&rsquo;m going to use an Azure Function. This will be an HTTP trigger that listens for a POST with a body containing JSON with values for <code>red</code>, <code>green</code> and <code>blue</code>. This JSON will be parsed and the values used to update the digital twin:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;red&#34;</span> : <span style=color:#ae81ff>0</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;green&#34;</span> : <span style=color:#ae81ff>0</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;blue&#34;</span> : <span style=color:#ae81ff>255</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>To help with Azure IoT projects, there is a <a href=https://www.nuget.org/packages/Microsoft.Azure.Devices/>Microsoft.Azure.Devices</a> NuGet package. This contains a <code>RegistryManager</code> class that can be used to manage devices, and this <code>RegistryManager</code> is created using a connection string for the IoT Hub.</p><p>Each IoT Hub can have multiple connection strings, all based around their different <a href="https://docs.microsoft.com/azure/iot-hub/iot-hub-devguide-security#access-control-and-permissions/?WT.mc_id=mxchip-blog-jabenn">permissions</a>. To control a device twin you need these <a href="https://docs.microsoft.com/azure/iot-hub/iot-hub-devguide-security#iot-hub-permissions/?WT.mc_id=mxchip-blog-jabenn">permissions</a>:</p><ul><li><strong>Registry Read</strong> - Allows reading from the IoT registry</li><li><strong>Service Connect</strong> - Allows connections to the IoT Hub to manage devices and setting, this is designed for services to connect, as opposed to devices connecting.</li></ul><p>From inside the portal:</p><ul><li>Open up the newly created IoT hub</li><li>Select <em>Settings->Shared access policies</em></li><li>Click <strong>+ Add</strong> to create a new shared access policy, call it <em>Twin</em> and allow <em>Registry Read</em> and <em>Service Connect</em></li><li>Save this, and copy one of the connection strings using the <strong>Copy</strong> button next to it</li></ul><div class=image-div style=max-width:300px><p><img src=2018-11-19_14-17-57.png alt="Configuring a new shared access policy"></p></div><p>Once the connection string has been created it can be used to create the <code>RegistryManager</code>, ideally by setting this in the function app settings.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cs data-lang=cs><span style=display:flex><span><span style=color:#66d9ef>var</span> connectionString = Environment.GetEnvironmentVariable(<span style=color:#e6db74>&#34;iotHubConnectionString&#34;</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>var</span> registryManager = RegistryManager.CreateFromConnectionString(connectionString);
</span></span></code></pre></div><p>The device twin can then be retrieved using the <code>RegistryManager</code> and the name of the IoT device that was used when it was registered in the Hub (again ideally as a setting):</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cs data-lang=cs><span style=display:flex><span><span style=color:#66d9ef>var</span>  deviceName = Environment.GetEnvironmentVariable(<span style=color:#e6db74>&#34;iotHubDevice&#34;</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>var</span> twin = <span style=color:#66d9ef>await</span> registryManager.GetTwinAsync(deviceName);
</span></span></code></pre></div><p>This twin can then be updated by passing a JSON string containing a patch to apply, and the values in the patch are applied to the twin. In this case, the <code>rgbLEDR</code>, <code>rgbLEDG</code> and <code>rgbLEDB</code> values need to be added to the <code>desired</code> node in the <code>properties</code> node, and this can be done by creating an anonymous type with the right names and serializing it to JSON.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cs data-lang=cs><span style=display:flex><span><span style=color:#66d9ef>var</span> patch = <span style=color:#66d9ef>new</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    properties = <span style=color:#66d9ef>new</span>
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        desired = <span style=color:#66d9ef>new</span>
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            rgbLEDR = red,
</span></span><span style=display:flex><span>            rgbLEDG = green,
</span></span><span style=display:flex><span>            rgbLEDB = blue,
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>var</span> jsonPatch = JsonConvert.SerializeObject(patch);
</span></span></code></pre></div><p>This patch is then used to update the twin:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cs data-lang=cs><span style=display:flex><span><span style=color:#66d9ef>await</span> registryManager.UpdateTwinAsync(twin.DeviceId, jsonPatch, twin.ETag);
</span></span></code></pre></div><p>That&rsquo;s all that is needed to update the twin. The full code for this function is available <a href=https://github.com/jimbobbennett/IoTLedColorChanger/blob/master/BackEnd/IotLedColorChanger.Functions/IoTFunctions.cs>here</a>. To test this out:</p><ul><li>Set the appropriate values for the connection string and device hub in the <code>local.settings.json</code> file</li><li>Run the function app using the local functions host</li><li>Post a JSON document to the function using a tool such as <a href=https://www.getpostman.com/apps>Postman</a></li><li>The LED will change color based on the JSON that was posted</li></ul><p>Once the function is running, it can be deployed to Azure so that it can be called from a mobile app. Once deployed, the application settings will need to be set for the IoT Hub connection string and device name. This function can then be called by a tool like Postman to verify it is working.</p><h4 id=building-the-mobile-app>Building the mobile app</h4><p>The mobile app is pretty simple - three sliders and a button. Use the sliders to set RGB values, the button changes color as they slide, and when you tap the button it sends the RGB value to the back end. I built the app using <a href=https://github.com/fsprojects/Fabulous>Fabulous</a>, a F# MVU architecture that sits on top of <a href="https://visualstudio.microsoft.com/xamarin/?WT.mc_id=mxchip-blog-jabenn">Xamarin</a>. The code for this is pretty simple, with the values from the sliders being passed to an <code>HTTP.AsyncRequest</code> from <a href=http://fsharp.github.io/FSharp.Data/index.html>FSharp.Data</a>. This calls the Azure Functions back end to update the device twin.</p><p>Here&rsquo;s the app running in all it&rsquo;s glory!</p><div class=image-div style=max-width:500px><p><img src=Running.gif alt></p></div><h4 id=summary>Summary</h4><p>This post showed how to control the LED on an MXChip board using Azure device twins.</p><p>All the code for this is on my <a href=https://github.com/jimbobbennett/IoTLedColorChanger>GitHub</a>.</p><p>Here&rsquo;s some further reading:</p><ul><li>Learn more about the Azure IoT hub <a href="https://azure.microsoft.com/services/iot-hub/?WT.mc_id=mxchip-blog-jabenn">here</a></li><li><a href=http://mxchip.com/az3166>Places to buy an MXChip board</a></li><li>Microsoft.Azure.Devices API docs: <a href="https://docs.microsoft.com/dotnet/api/overview/azure/iot/client/?WT.mc_id=mxchip-blog-jabenn">docs.microsoft.com</a></li><li><a href=https://github.com/fsprojects/Fabulous>Fabulous getting started guide</a></li><li><a href=https://googoo.com>Goo Goo Clusters</a> - feel free to buy me some!</li></ul></article></div></div><div class="col-sm-12 col-md-12 col-lg-3"><div class=sticky-sidebar><aside class=toc><h5>Table Of Contents</h5><div class=toc-content><nav id=TableOfContents><ul><li><ul><li><a href=#getting-started-with-the-iot-devkit>Getting started with the IoT DevKit</a></li><li><a href=#controlling-the-board-from-the-cloud>Controlling the board from the cloud</a></li></ul></li></ul></nav></div></aside><aside class=tags><h5>Tags</h5><ul class="tags-ul list-unstyled list-inline"><li class=list-inline-item><a href=https://jimbobbennett.dev/tags/technology target=_blank>Technology</a></li><li class=list-inline-item><a href=https://jimbobbennett.dev/tags/azure target=_blank>azure</a></li><li class=list-inline-item><a href=https://jimbobbennett.dev/tags/azure-free target=_blank>azure free</a></li><li class=list-inline-item><a href=https://jimbobbennett.dev/tags/functions target=_blank>functions</a></li><li class=list-inline-item><a href=https://jimbobbennett.dev/tags/xamarin target=_blank>xamarin</a></li><li class=list-inline-item><a href=https://jimbobbennett.dev/tags/xamarin.forms target=_blank>xamarin.forms</a></li><li class=list-inline-item><a href=https://jimbobbennett.dev/tags/iot target=_blank>IoT</a></li><li class=list-inline-item><a href=https://jimbobbennett.dev/tags/googoo-clusters target=_blank>GooGoo clusters</a></li></ul></aside></div></div></div><div class=row><div class="col-sm-12 col-md-12 col-lg-9 p-4"><div id=disqus_thread></div><script>var disqus_config=function(){this.page.url="https://jimbobbennett.dev/blogs/controlling-an-iot-device-from-your-phone/",this.page.identifier="804ec03a6ab9f75d65dd2345ac668ba3"};(function(){if(window.location.hostname=="localhost")return;var e=document,t=e.createElement("script");t.src="https://jimbobbennett.disqus.com/embed.js",t.setAttribute("data-timestamp",+new Date),(e.head||e.body).appendChild(t)})()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript></div></div></div><button class="p-2 px-3" onclick=topFunction() id=topScroll>
<i class="fas fa-angle-up"></i></button></section><script>var topScroll=document.getElementById("topScroll");window.onscroll=function(){scrollFunction()};function scrollFunction(){document.body.scrollTop>20||document.documentElement.scrollTop>20?topScroll.style.display="block":topScroll.style.display="none"}function topFunction(){document.body.scrollTop=0,document.documentElement.scrollTop=0}</script></div><footer><div class="container py-4"><div class="row justify-content-center"><div class="col-md-4 text-center">&copy; 2023 All Rights Reserved</div></div></div></div></footer><script src=https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.min.js integrity=sha384-QJHtvGhmr9XOIpI6YVutG+2QOK9T+ZnN4kzFN1RtK3zEFEIsxhlmWl5/YESvpZ13 crossorigin=anonymous></script><script>document.body.className.includes("light")&&(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))</script><script>let loadingIcons;function loading(){myVar=setTimeout(showPage,100)}function showPage(){try{document.getElementById("loading-icons").style.display="block"}catch{}}</script><script>function createCopyButton(e,t){const n=document.createElement("button");n.className="copy-code-button",n.type="button",n.innerText="Copy",n.addEventListener("click",()=>copyCodeToClipboard(n,e,t)),addCopyButtonToDom(n,e)}async function copyCodeToClipboard(e,t,n){const s=t.querySelector("pre > code").innerText;try{n.writeText(s)}finally{codeWasCopied(e)}}function codeWasCopied(e){e.blur(),e.innerText="Copied!",setTimeout(function(){e.innerText="Copy"},2e3)}function addCopyButtonToDom(e,t){t.insertBefore(e,t.firstChild);const n=document.createElement("div");n.className="highlight-wrapper",t.parentNode.insertBefore(n,t),n.appendChild(t)}if(navigator&&navigator.clipboard)document.querySelectorAll(".highlight").forEach(e=>createCopyButton(e,navigator.clipboard));else{var script=document.createElement("script");script.src="https://cdnjs.cloudflare.com/ajax/libs/clipboard-polyfill/2.7.0/clipboard-polyfill.promise.js",script.integrity="sha256-waClS2re9NUbXRsryKoof+F9qc1gjjIhc2eT7ZbIv94=",script.crossOrigin="anonymous",script.onload=function(){addCopyButtons(clipboard)},document.querySelectorAll(".highlight").forEach(e=>createCopyButton(e,script)),document.body.appendChild(script)}</script></body></html>